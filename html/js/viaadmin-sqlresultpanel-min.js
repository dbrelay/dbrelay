/** va.SqlResultPanel */
Ext.namespace('va');va.SqlResultPanel=Ext.extend(Ext.Panel,{cls:'va-sqlresultpanel',iconCls:'vaicon-sql',layout:'border',closable:true,initComponent:function(){var idpfx=Ext.id();this.cm=new Ext.grid.ColumnModel([]);this.store=new Ext.data.Store();this.items=[{region:'north',height:80,split:true,collapsible:true,layout:'fit',unstyled:true,items:{xtype:'textarea',id:'sqlcode'+idpfx,allowBlank:false,enableKeyEvents:true,selectOnFocus:true,listeners:{'keyup':{fn:function(fld,e){if(e.shiftKey&&e.keyCode===e.ENTER){this.execSql();}},scope:this}}},tbar:[{iconCls:'vaicon-minus',text:'Clear',handler:function(){this.fldSqlCode.setValue('');},scope:this},'-',{text:'Execute SQL [Shift + Enter]',iconCls:'vaicon-tick',tooltip:'Execute SQL [Shift + Enter]',handler:this.execSql,scope:this}]},{region:'center',id:'resultsRegion'+idpfx,border:false,unstyled:true,layout:'card',activeItem:0,items:{id:'msg'+idpfx,unstyled:true}}];va.SqlResultPanel.superclass.initComponent.call(this);this.fldSqlCode=this.findById('sqlcode'+idpfx);this.msgPanel=this.findById('msg'+idpfx);this.idpfx=idpfx;},execSql:function(){if(!this.fldSqlCode.validate()){return;}
this.sqlDb.executeSql(this.fldSqlCode.getValue(),function(sqld,resp){if(resp.log.error){this.showMsgPanel('<p style="color:red">Error:</p><pre style="color:red">'+resp.log.error+'</pre>');}
else{var data=resp.data[0];if(data.fields.length===0){this.showMsgPanel('<p style="color:green">Success: '+data.count+' rows affected.</p>');}
else{this.showResultsGrid(data);}}},this);},showMsgPanel:function(msg){Ext.getCmp('resultsRegion'+this.idpfx).getLayout().setActiveItem(this.msgPanel);this.msgPanel.body.update(msg);},showResultsGrid:function(data){var cols=data.fields,rows=data.rows;var cmData=[],storeFields=[];for(var i=0,len=cols.length;i<len;i++){var col=cols[i],name=col.name;cmData[i]={header:name,sortable:true,id:name,dataIndex:name};storeFields[i]={name:name,type:'string'};}
var store=new Ext.data.JsonStore({autoDestroy:true,data:{rows:rows},root:'rows',fields:storeFields});var cm=new Ext.grid.ColumnModel(cmData);if(!this.grid){this.grid=new Ext.grid.GridPanel({viewConfig:{forceFit:true,autoFill:true},tbar:['<span id="total'+this.idpfx+'"></span> rows total','-','Show',{xtype:'numberfield',id:'pagesize'+this.idpfx,width:30,enableKeyEvents:true,selectOnFocus:true,listeners:{'blur':{fn:this.updatePageView,scope:this},'keyup':{fn:function(b,e){if(e.keyCode===e.ENTER){this.updatePageView();}},scope:this}}},'Rows','-',{iconCls:'vaicon-first',handler:function(){this.showPage(1);},scope:this},{iconCls:'vaicon-back',handler:function(){var page=this.pageNumberField.getValue();this.showPage(page===1?1:page-1);},scope:this},'Page',{xtype:'numberfield',id:'page'+this.idpfx,width:30,enableKeyEvents:true,selectOnFocus:true,listeners:{'blur':{fn:this.updatePageView,scope:this},'keyup':{fn:function(b,e){if(e.keyCode===e.ENTER){this.updatePageView();}},scope:this}}},'of <span id="totalPages'+this.idpfx+'"></span>',{iconCls:'vaicon-next',handler:function(){var page=this.pageNumberField.getValue();this.showPage(page===this.totalPages?page:page+1);},scope:this},{iconCls:'vaicon-last',handler:function(){this.showPage(this.totalPages);},scope:this}],pageSize:50,pageNumber:1,totalPages:1,cm:cm,store:store});var results=Ext.getCmp('resultsRegion'+this.idpfx);results.add(this.grid);results.getLayout().setActiveItem(this.grid);this.doLayout();this.pageNumberField=Ext.getCmp('page'+this.idpfx);this.pageSizeField=Ext.getCmp('pagesize'+this.idpfx);this.pageNumberField.setValue(this.grid.pageNumber);this.pageSizeField.setValue(this.grid.pageSize);}
else{this.grid.reconfigure(store,cm);}
this.tableData=rows;this.totalRows=data.count;Ext.get('total'+this.idpfx).update(this.totalRows);this.totalPages=Math.floor((this.totalRows/this.pageSize)+1);Ext.get('totalPages'+this.idpfx).update(this.totalPages);this.updatePageView();},showPage:function(page){this.pageNumberField.suspendEvents();this.pageNumberField.setValue(page);this.pageNumberField.resumeEvents();this.updatePageView();},updatePageView:function(){var pageNumber=this.pageNumberField.getValue();if(pageNumber>this.totalPages){this.pageNumberField.suspendEvents();this.pageNumberField.setValue(this.totalPages);this.pageNumberField.resumeEvents();}
var pageSize=this.pageSizeField.getValue();var