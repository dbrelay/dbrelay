/* viaadmin */
/* SqlTableEditor */

Ext.namespace('va');va.SqlTableEditor=Ext.extend(Ext.Panel,{cls:'va-sqltableeditor',layout:'border',iconCls:'vaicon-table',sqlTable:null,pkeyColumns:[],pkeyStyle:'color:#00761c;font-weight:bold;',DELETE_INDEX:'va-deletebox',ADD_INDEX:'va-newrow',pageSize:50,pageNumber:1,totalPages:1,where:'',orderBy:'',serverSidePaging:true,initComponent:function(){var idpfx=Ext.id();Ext.QuickTips.init();this.title=this.title||'TABLE: '+this.tableName;this.tbar=[{xtype:'button',text:'Run/Refresh',tooltip:'Refresh columns & data from server',iconCls:'vaicon-refresh',handler:function(){if(confirm('Refreshing will revert and outstanding edits you may have. Are you sure you want to refresh?')){this.refresh();}},scope:this},'-',{xtype:'button',text:'Commit Changes',tooltip:'Commit all changes (adds, deletes, edits) to table in database',iconCls:'vaicon-disk',handler:function(){if(confirm('Are you sure you want to save changes to the server?')){this.updateSelectedRows();}},scope:this},'-',{text:'Add Row',tooltip:'Add new row to table',iconCls:'vaicon-plus',handler:function(){var grid=this.grid,store=grid.getStore(),Row=store.recordType;var newRec=new Row(Ext.apply({},this.addRowDefaults));newRec.set(this.ADD_INDEX,true);grid.stopEditing();store.insert(0,newRec);grid.startEditing(0,1);},scope:this},'-',{iconCls:'vaicon-find',enableToggle:true,pressed:true,text:'Filtering',tooltip:'More options',handler:function(b,e){this.optionsPanel.setVisible(this.optionsPanel.hidden);this.doLayout();},scope:this},'->','<b><span id="total'+idpfx+'"></span></b> total','-',{xtype:'numberfield',id:'pagesize'+idpfx,width:30,value:this.pageSize,enableKeyEvents:true,selectOnFocus:true,listeners:{'blur':{fn:this.updatePageView,scope:this},'keyup':{fn:function(b,e){if(e.keyCode===e.ENTER){this.updatePageView();}},scope:this}}},'/page','-',{iconCls:'vaicon-first',tooltip:'Go to first page',handler:function(){this.showPage(1);},scope:this},{iconCls:'vaicon-back',tooptip:'Go to previous page',handler:function(){var page=this.pageNumberField.getValue();this.showPage(page===1?1:page-1);},scope:this},'Page',{xtype:'numberfield',id:'page'+idpfx,width:30,value:this.pageNumber,enableKeyEvents:true,selectOnFocus:true,listeners:{'blur':{fn:this.updatePageView,scope:this},'keyup':{fn:function(b,e){if(e.keyCode===e.ENTER){this.updatePageView();}},scope:this}}},'of <span id="totalPages'+idpfx+'"></span>',{iconCls:'vaicon-next',tooltip:'Go to next page',handler:function(){var page=this.pageNumberField.getValue();this.showPage(page===this.totalPages?page:page+1);},scope:this},{iconCls:'vaicon-last',tooltip:'Go to last page',handler:function(){this.showPage(this.totalPages);},scope:this}];this.deleteBox=new va.DeleteBox({header:'Del',id:'check',dataIndex:this.DELETE_INDEX,width:25,resizable:false});this.items=[{region:'north',id:'options'+idpfx,height:100,split:true,layout:'anchor',border:false,unstyled:true,listeners:{'expand':{fn:function(p){p.doLayout();}},'resize':{fn:function(p,aw,ah){this.whereField.setHeight(ah-35);this.orderByField.setHeight(ah-35);},scope:this}},items:[{layout:'column',border:false,anchor:'100% 100%',unstyled:true,items:[{columnWidth:0.66,layout:'form',border:false,unstyled:true,labelAlign:'top',anchor:'100%',items:[{fieldLabel:"WHERE (ex: color='red' )",xtype:'textarea',id:'where'+idpfx,anchor:'95%',height:80,enableKeyEvents:true,selectOnFocus:true,listeners:{'keyup':{fn:function(fld,e){if(e.ctrlKey&&e.keyCode===e.ENTER){this.refresh();}},scope:this}},value:this.where}]},{columnWidth:0.33,layout:'form',border:false,unstyled:true,labelAlign:'top',items:[{fieldLabel:'ORDER BY (ex: first_name asc)',id:'orderby'+idpfx,xtype:'textarea',anchor:'95%',height:80,enableKeyEvents:true,selectOnFocus:true,listeners:{'keyup':{fn:function(fld,e){if(e.keyCode===e.ENTER){this.refresh();}},scope:this}},value:this.orderBy}]}]}]},{region:'center',xtype:'editorgrid',border:false,id:'grid'+idpfx,clicksToEdit:1,viewConfig:{forceFit:true,autoFill:true},plugins:[this.deleteBox],store:new Ext.data.Store(),cm:new Ext.grid.ColumnModel([this.deleteBox])}];va.SqlTableEditor.superclass.initComponent.call(this);this.on('render',function(p){this.pageNumberField=Ext.getCmp('page'+idpfx);this.pageSizeField=Ext.getCmp('pagesize'+idpfx);this.orderByField=Ext.getCmp('orderby'+idpfx);this.whereField=Ext.getCmp('where'+idpfx);this.refresh();},this,{single:true});this.sqlTable=sqlTable(this.tableName,this.sqlDb);this.grid=this.findById('grid'+idpfx);this.optionsPanel=this.findById('options'+idpfx);this.idpfx=idpfx;},updateSelectedRows:function(){var recs=this.grid.getStore().getModifiedRecords();if(recs.length===0){return;}
var updateRows=[],addRows=[],deleteRows=[],updateWhereRows=[],pkeys=this.pkeyColumns;var removedRecs=[],addedRecs=[],updatedRecs=[];for(var i=0,len=recs.length;i<len;i++){var rec=recs[i];var where={};for(var p=0;p<pkeys.length;p++){var k=pkeys[p];where[k]=rec.modified[k]||rec.data[k];}
if(rec.data[this.DELETE_INDEX]===true){if(rec.data[this.ADD_INDEX]===true){this.grid.getStore().remove(rec);continue;}
else{deleteRows.push(where);removedRecs.push(rec);}}
else if(rec.data[this.ADD_INDEX]===true){var arow=rec.data;if(arow[this.ADD_INDEX]){delete arow[this.ADD_INDEX];}
addRows.push(arow);addedRecs.push(rec);}
else{var mrow=rec.getChanges();updateWhereRows.push(where);if(mrow[this.DELETE_INDEX]){delete mrow[this.DELETE_INDEX];}
updateRows.push(mrow);updatedRecs.push(rec);}}
if(deleteRows.length>0){this.sqlTable.deleteRows(deleteRows,function(sqlt,resp){if(resp.data){for(var i=0;i<removedRecs.length;i++){this.grid.getStore().remove(removedRecs[i]);}}},this);}
if(addRows.length>0){this.sqlTable.addRows(addRows,function(sqlt,resp){if(resp.data){for(var i=0;i<addedRecs.length;i++){addedRecs[i].commit();}}},this);}
if(updateRows.length>0){this.sqlTable.updateRows(updateRows,updateWhereRows,function(sqlt,resp){if(resp.data){for(var i=0;i<updatedRecs.length;i++){updatedRecs[i].commit();}}},this);}},showPage:function(page){this.pageNumberField.suspendEvents();this.pageNumberField.setValue(page);this.pageNumberField.resumeEvents();this.updatePageView();},updatePageView:function(){var pageNumber=this.pageNumberField.getValue();if(pageNumber>this.totalPages){this.pageNumberField.suspendEvents();this.pageNumberField.setValue(this.totalPages);this.pageNumberField.resumeEvents();}
var pageSize=this.pageSizeField.getValue();this.where=this.whereField.getValue();this.orderBy=this.orderByField.getValue();var start=(pageNumber-1)*pageSize;if(this.serverSidePaging){this.displayMask('Fetching Data...');this.sqlTable.fetchPagingRows({pagingSize:pageSize,recordStart:this.pageSize*(pageNumber-1),where:this.where,orderBy:this.orderBy},function(sqlt,resp,ocfg,ncfg){this.hideMask();if(!resp.data){return;}
this.tableData=resp.data[0].rows;this.grid.getStore().loadData({'rows':this.tableData});},this);}
else{this.grid.getStore().loadData({'rows':this.tableData.slice(start,start+pageSize)});}
this.pageNumber=pageNumber;this.pageSize=pageSize;this.totalPages=Math.floor((this.totalRows/pageSize)+1);Ext.get('totalPages'+this.idpfx).update(this.totalPages);},displayMask:function(msg){this.body.mask(msg);},hideMask:function(){this.body.unmask();},refresh:function(){this.displayMask('Querying columns...');if(!this.optionsPanel.hidden){this.where=this.whereField.getValue();this.orderBy=this.orderByField.getValue();}
this.sqlTable.queryColumns(function(sqlt,resp,cols){this.displayMask('Querying primary keys...');this.sqlTable.queryPrimaryKeys(function(sqlt,resp2,keys){this._finishRefresh(keys,cols);},this);},this);},_finishRefresh:function(pkeys,cols){var fm=Ext.form,cmData=[],storeFields=[];this.addRowDefaults={};var pkeystr='~'+pkeys.join('~')+'~';this.pkeyColumns=pkeys;cmData[0]=this.deleteBox;storeFields[0]={name:this.DELETE_INDEX};for(var i=0,len=cols.length;i<len;i++){var col=cols[i],name=col.name;var iskey=pkeystr.indexOf('~'+name+'~')!==-1;cmData[i+1]={header:name+(iskey?' [KEY]':''),sortable:true,id:name,pkey:iskey,css:iskey?this.pkeyStyle:null,dataIndex:name,editor:new Ext.form.TextField({allowBlank:false})};this.addRowDefaults[name]='';storeFields[i+1]={name:name,type:'string'};}
var store=new Ext.data.JsonStore({autoDestroy:true,data:{rows:[]},root:'rows',fields:storeFields});this.grid.reconfigure(store,new Ext.grid.ColumnModel(cmData));if(this.serverSidePaging){this.sqlTable.queryTotalRows({pkeys:this.pkeyColumns.join(','),where:this.where},function(sqlt,resp,total){if(resp.data){this.setTotalCount(total);this.updatePageView();}},this);}
else{this.displayMask('Querying Data...');this.sqlTable.fetchRows({where:this.where,orderBy:this.orderBy},function(sqlt,resp){if(resp&&resp.data){this.displayMask('Preparing Data for Display...');this.tableData=resp.data[0].rows;this.setTotalCount(resp.data[0].count);this.updatePageView();}
this.hideMask();},this);}},setTotalCount:function(n){this.totalRows=n;Ext.get('total'+this.idpfx).update(n);}});Ext.reg('va_sqltableeditor',va.SqlTableEditor);va.DeleteBox=function(config){Ext.apply(this,config);if(!this.id){this.id=Ext.id();}
this.renderer=this.renderer.createDelegate(this);};va.DeleteBox.prototype={init:function(grid){this.grid=grid;this.grid.on('render',function(){var view=this.grid.getView();view.mainBody.on('mousedown',this.onMouseDown,this);},this);},onMouseDown:function(e,t){if(t.className&&t.className.indexOf('x-grid3-cc-'+this.id)!=-1){e.stopEvent();var index=this.grid.getView().findRowIndex(t);var record=this.grid.store.getAt(index);var tbl=Ext.get(t).findParentNode('.x-grid3-row-table',10,true);tbl.addClass('va-deletetablerow');record.set(this.dataIndex,record.data[this.dataIndex]?false:true);}},renderer:function(v,p,record){p.css+=' x-grid3-check-col-td';return'<div class="x-grid3-check-col'+(v?'-on':'')+' x-grid3-cc-'+this.id+'">&#160;</div>';}};