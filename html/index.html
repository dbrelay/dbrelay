<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Viaduct table example</title>
    <script src="js/jquery-1.3.2.min.js" type="text/javascript"></script>
    <script src="js/jquery-ui-1.7.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="tablesorter/jquery.tablesorter.min.js" type="text/javascript"></script>
    <script type="text/javascript" charset="utf-8">

      $(document).ajaxError(function(){
          if (window.console && window.console.error) {
              console.error(arguments);
          }
      });
      
      function viaductQuery( viaduct, connection, sql, callback, tag) {
        connection[ "sql" ] = sql;
        if ( tag !== undefined ) connection[ "query_tag" ] = tag;
        $.post( viaduct, connection, callback, "json");
      };
      
      var land = function () {
        $('#spinner').hide();
        $('#go').show().data('inflight', false);
      };
      
      $(document).ready(function() {
        var launch = function () {
          var go = $('#go');
          if (go.data('inflight') == true) return false;
          go.data('inflight', true).hide();
          $('#spinner').show();
          return true;
        };

        $('#sql').resizable({
          handles: "s,e",
          transparent: true
        });

        $('#go').click(function(){
          if ( ! launch() ) { return false ; };
          $('#results').empty();
          viaductQuery(
            '/sql',
            {
              'sql_server'   : $('#sql_server').val(),
              'sql_port'     : $('#sql_port').val(),
              'sql_database' : $('#sql_database').val(),
              'sql_user'     : $('#sql_user').val(),
              'sql_password' : $('#sql_password').val(),
              'connection_name' : $('#connection_name').val()
            },
            $('#sql').val(),
            processRowSets,
            'Example'
          );
        });
        
        $.get( "/eg/", function (data) {
          $(data).find('a')
          .filter('[href$=".html"]:not("[href^=.]"):not("[href^=?]")')
          .each( function(){
            page = $(this).attr('href');
            $('<p>').appendTo('#docs').prepend(
              $('<a>').attr('href', '/eg/' + page ).text( page.replace("_"," ").replace(/\.[^.]+$/,"") )
            );
          });
        });
        
      });
      
      function processRowSets( response ) {
        if (response.log.error) {
          alert(response.log.error);
        };
        for ( rs_id in response.data ) {
          rowset = response.data[ rs_id ];
          if ( rowset.count > 0 ){
            if ( rowset.rows && rowset.rows.length ) {
              t = makeTable( rowset );
            };
            $('<p>' + rowset.count + ' rows affected</p>' ).
            appendTo( '#results' );
          };
          $('<hr>').appendTo( '#results' );
        };
        land();
      };

      var makeTable = function( rowset ) {
        table = $( '<table>' );
        thead = $( '<thead>' ).appendTo( table );
        tr = $( '<tr>' ).appendTo( thead );
        headers = [];
        for ( field in rowset.fields ) {
          header = rowset.fields[ field ][ 'name' ];
          $( '<th>' ).html( header ).appendTo( tr );
          headers.push( header );
        };
        for ( row_id in rowset.rows ) {
          row = rowset.rows[ row_id ];
          tr = $( '<tr>' ).appendTo( table );
          for ( idx in headers ) {
            cell = row[ headers[ idx ] ];
            if ( cell == null ) {
              $( '<td>' ).html( '- &otimes; -').
              css( 'text-align', 'center' ).
              appendTo( tr );
            } else {
              $( '<td>' ).
              text( cell.toString() ).
              appendTo( tr );
            }
          };
        };
        table.appendTo( '#results' );
        table.addClass('tablesorter').tablesorter({
          cssHeader: 'header',
          cssAsc:    'headerSortUp',
          cssDesc:   'headerSortDown'
        });
        return table;
      };
    </script>
    <style type="text/css" media="screen">
      body, textarea, input, button { font-size: 12px; }
      table {
        border-collapse: collapse;
        margin-bottom: 0.5em; }
      table, thead, tbody, td, th, tr {
        border: 1px solid gray;}
      hr {
        border: 1px dotted grey;
        margin: 2em 0em; }
      label {
        width: 6em;
        text-align: right;
        float: left;
        padding-right: 1em; }
      #spinner {
        display: none;
        border: none;
        padding: 0;
        margin: 0;
      }
      #docs {
        float: right;
        text-align: right;
        padding: 1em;
        border: 1px solid grey;
        margin: 0em 1em 1em 1em;
      }
      #docs h3 { text-align: left; }
    </style>
    <link rel="stylesheet" type="text/css" href="tablesorter/style.css">
  </head>
  <body>
    <div id="docs">
      <h3>Documentation:</h3>
      <p><a href="doc/viaduct_specification.html">Specifications</a></p>
      <p><a href="doc/viaduct_architecture.pdf">Architecture</a></p>
    </div>
    <form id=accept-charset="utf-8">
      <label for="sql_server">Server</label><input type="text" name="sql_server" value="" id="sql_server"><br />
      <label for="sql_port">Port</label><input type="text" name="sql_port" value="" id="sql_port"><br />
      <label for="sql_database">Database</label><input type="text" name="sql_database" value="" id="sql_database"><br />
      <label for="sql_user">User</label><input type="text" name="sql_user" value="" id="sql_user"><br />
      <label for="sql_password">Password</label><input type="password" name="sql_password" value="" id="sql_password"><br />
      <label for="connection_name">Connection</label><input type="text" name="connection_name" value="" id="connection_name"><br />
      <label for="sql">Query</label><textarea name="sql" rows="8" cols="80" id="sql"></textarea>
      <p>
        <input type="button" id="go" value="GO&nbsp;&nbsp;&gt;&nbsp;&gt;&nbsp;&gt;">
        <img id="spinner" src="img/spinner.gif" />
      </p>
    </form>
    <div id="results">
    </div>
  </body>
</html>
