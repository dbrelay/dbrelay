<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Viaduct table example</title>
    <script src="jquery-1.2.6.pack.js" type="text/javascript"></script>
    <script src="tablesorter/jquery.tablesorter.min.js" type="text/javascript"></script>
    <script type="text/javascript" charset="utf-8">

      $(document).ajaxError(function(){
          if (window.console && window.console.error) {
              console.error(arguments);
          }
      });
      
      function viaductQuery( viaduct, connection, sql, callback, tag) {
        connection[ "sql" ] = sql;
        if ( tag !== undefined ) connection[ "query_tag" ] = tag;
        $.post( viaduct, connection, callback, "json");
      };

      $(document).ready(function() {
        $('#go').click(function(){
          $('#results').empty();
          viaductQuery(
            '/sql',
            {
              'sql_server'   : $('#sql_server')[0].value,
              'sql_port'     : $('#sql_port')[0].value,
              'sql_database' : $('#sql_database')[0].value,
              'sql_user'     : $('#sql_user')[0].value,
              'sql_password' : $('#sql_password')[0].value
            },
            $('#sql')[0].value,
            processRowSets,
            'Example'
          );
        })
      });
      
      function processRowSets( response ) {
        if (response.log.error) {
          alert(response.log.error);
        };
        for ( rs_id in response.data ) {
          rowset = response.data[ rs_id ];
          if ( rowset.count ){
            t = makeTable( rowset );
          };
          $('<hr>').appendTo( '#results' );
        };
        // $('<pre>').html(response.log.sql).appendTo( '#results' );
      };

      var makeTable = function( rowset ) {
        table = $( '<table>' );
        thead = $( '<thead>' ).appendTo( table );
        tr = $( '<tr>' ).appendTo( thead );
        headers = [];
        for ( field in rowset.fields ) {
          header = rowset.fields[ field ][ 'name' ];
          $( '<th>' ).html( header ).appendTo( tr );
          headers.push( header );
        };
        for ( row_id in rowset.rows ) {
          row = rowset.rows[ row_id ];
          tr = $( '<tr>' ).appendTo( table );
          for ( idx in headers ) {
            cell = row[ headers[ idx ] ];
            if ( cell == null ) {
              $( '<td>' ).html( '- &otimes; -').
              css( 'text-align', 'center' ).
              appendTo( tr );
            } else {
              $( '<td>' ).
              text( cell.toString() ).
              appendTo( tr );
            }
          };
        };
        table.appendTo( '#results' );
        table.addClass('tablesorter').tablesorter({
          cssHeader: 'header',
          cssAsc:    'headerSortUp',
          cssDesc:   'headerSortDown'
        });
        return table;
      };
    </script>
    <style type="text/css" media="screen">
      body, textarea, input, button { font-size: 12px; }
      table {
        border-collapse: collapse;
        margin-bottom: 0.5em; }
      table, thead, tbody, td, th, tr {
        border: 1px solid gray;}
      hr {
        border: 1px dotted grey;
        margin: 2em 0em; }
      label {
        width: 6em;
        text-align: right;
        float: left;
        padding-right: 1em; }
    </style>
    <link rel="stylesheet" type="text/css" href="tablesorter/style.css">
  </head>
  <body>
    <div style="float:right;">
      <p><a href="doc/viaduct_specification.html">Specifications</a></p>
      <p><a href="doc/viaduct_architecture.pdf">Architecture</a></p>
      <p><a href="example.html">Python example</a></p>
    </div>
    <form id=accept-charset="utf-8">
      <label for="sql_server">Server</label><input type="text" name="sql_server" value="" id="sql_server"><br />
      <label for="sql_port">Port</label><input type="text" name="sql_port" value="" id="sql_port"><br />
      <label for="sql_database">Database</label><input type="text" name="sql_database" value="" id="sql_database"><br />
      <label for="sql_user">User</label><input type="text" name="sql_user" value="" id="sql_user"><br />
      <label for="sql_password">Password</label><input type="password" name="sql_password" value="" id="sql_password"><br />
      <label for="sql">Query</label><textarea name="sql" rows="8" cols="80" id="sql"></textarea>
      <p><input type="button" id="go" value="GO&nbsp;&nbsp;&gt;&nbsp;&gt;&nbsp;&gt;"></p>
    </form>
    <div id="results">
    </div>
  </body>
</html>
