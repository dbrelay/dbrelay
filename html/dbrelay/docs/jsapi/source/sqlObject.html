<html>
<head>
  <title>The source code</title>
    <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
</head>
<body  onload="prettyPrint();">
    <pre class="prettyprint lang-js">
(function(){
	var param_re = /{{{([""'']?\w+)}}}/g;
	var divid_re = /({{{[\'\"]?)|(}}})/g;
	
	<div id="cls-DbRelay"></div>/** 
	DbRelay core Javascript API.  
	@class DbRelay
	@singleton
	*/
	DbRelay = {
		adapters : {},
		<div id="prop-DbRelay-DBRELAY_HOST"></div>/** global var to hold default DBRelay host (default to "" for same domain).  This can be overridden by individual queries   */
		DBRELAY_HOST : null,

		<div id="method-DbRelay-query"></div>/**
		 Send a SQL query through DbRelay, calling the passed callbacks with the response.
		@param {Object} connection Dbrelay connection object.  Example parameters:
		<ul class="mdetail-params">
		     <li><b>sql_server</b> : String<div class="sub-desc">Hostname on which the SQL server is running. </div></li>
				<li><b>sql_database</b> : String<div class="sub-desc">Optional name of the primary database for the connection. User's default database is used, if not specified.</div></li>
				<li><b>sql_user</b> : String<div class="sub-desc">Username string recognised by the SQL server.   </div></li>
				<li><b>sql_password</b> : String<div class="sub-desc">password for the sql_user. </div></li>
				<li><b>connection_name</b> : String<div class="sub-desc">Optional (HIGHLY RECOMMENDED) name to persist this connection under.</div></li>
				<li><b>dbrelay_host</b> : String<div class="sub-desc">Optional parameter for xss scripting.  Leave out for same-domain scripts</div></li>
		     <li><b>sql_port</b> : String/Number<div class="sub-desc">Optional port number, on which the SQL server is listening. 1433 is the default.</div></li>
		 </ul>
		
@param {String} sql SQL query
@param {Function} success callback function on a successful query.  One arguments is passed:<ul class="mdetail-params">
     <li><b>response</b> : Object<div class="sub-desc">DbRelay JSON response object</div></li>
 </ul>

@param {Function} error error callback function
@param {Object} scope Optional scope for the success & error callbacks
@param {String} query_tag Optional query_tag that will be returned in the results.  Useful for determining which query results are from.
		*/
		query : function(connection, sql, callback, error, scope, query_tag){
			//copy connection info into params
			var params = {};

			for(var k in connection){
				if(k !== 'dbrelay_host'){
					params[k] = connection[k];       
				}
			}
			//override sql
			params.sql = sql;
			params.query_tag = query_tag || null;

			var dbrHost = connection.dbrelay_host || DbRelay.DBRELAY_HOST;
			
			if(dbrHost){        
				jQuery.getJSON( dbrHost + '/sql?js_callback=?', params , function(response){
					if(response && response.data){
						callback.call( scope || window, response);
					}
					else{
						if(error){
							error.call( scope || window, response);
						}
					}
					
				});   
			} 
			else{
				$.post( '/sql', params, function(response){
					if(response && response.data){
						callback.call( scope || window, response);
					}
					else{
						if(error){
							error.call( scope || window, response);
						}
					}
				}, "json" );    
			}
		},
	
		<div id="method-DbRelay-queryStatus"></div>/**
		Query for connection status.  Cross-domain compatible dbrelay status call.
		@param callback {function} REQUIRED callback function that will be called with the following parameters:<ul class="mdetail-params">
		     <li><b>response</b> : Object<div class="sub-desc">DbRelay JSON response object</div></li>
		 </ul>
		@param {Object} scope Optional scope for the callback
		@param {string} dbrhost optional dbrelay host (xss) in format "http(s)://hostname"
*/
		queryStatus : function(callback, scope, dbrhost) {
			var params = {
				status: 1
			};
			
			dbrhost = dbrhost || DbRelay.DBRELAY_HOST;
			if(dbrhost){           
				jQuery.getJSON( dbrhost + '/sql?js_callback=?', params , function(response){
					callback.call( scope || window, response);
				});   
			} 
			else{
				$.post( '/sql', params, function(response){
					callback.call( scope || window, response);
				}, "json" );    
			}  
		},
	
		<div id="method-DbRelay-kill"></div>/**
		Cross-domain compatible dbrelay kill connection
		@param {String} sockpath socket path value of the connection to kill.  Use {@link #queryStatus DbRelay.queryStatus} to find the sockpath.
		@param {function} callback callback function that will be called with the following parameters:<ul class="mdetail-params">
		     <li><b>response</b> : Object<div class="sub-desc">DbRelay JSON response object</div></li>
		 </ul>
		@param {Object} scope Optional scope for the callback
		@param {string} dbrhost optional dbrelay host (xss) in format "http(s)://hostname"
		*/
		kill : function(sockpath, callback, scope, dbrhost) {
			var params = {
				cmd: 'kill',
				param1 : sockpath
			};
			
			var dbrhost = dbrhost || DbRelay.DBRELAY_HOST;
			if(dbrhost){           
				jQuery.getJSON( dbrhost + '/sql?js_callback=?', params , function(response){
					callback.call( scope || window, response);
				});   
			} 
			else{
				$.post( '/sql', params, function(response){
					callback.call( scope || window, response);
				}, "json" );    
			}  
		},
	
		<div id="method-DbRelay-quoteSingles"></div>/**
		Utility String function that replaces all single quotes (') in a string with two single quotes ('')
		@param {string} text the source string
		@return {string} the return string
		*/
		quoteSingles : function( text ) { return text.replace(/'/g,"''"); },

		<div id="method-DbRelay-quoteDoubles"></div>/**
		Utility String function that replaces all double quotes (") in a string with two double quotes ("")
		@param {string} text the source string
		@return {string} the return string
		*/
	  quoteDoubles : function( text ) { return text.replace(/"/g,'""'); },

		<div id="method-DbRelay-cook"></div>/**
				A simple HTML template parser
				@param {String} string template string, with {{{param_name}}} 
				@param {Object} params An object of values for the template, keyed by param name
				@return {String} A parsed string where all instances of {{{param_name}}} in the template are replaced by associated values in the params parameter
		*/
		cook : function( string, params ) {
	    return string.replace( param_re, function( match, word ) {
	      var quoteFunc = undefined;
	      if ( word.charAt(0) == "'" ) { word = word.slice(1); quoteFunc = Dbrelay.Util.quoteSingles; };
	      if ( word.charAt(0) == '"' ) { word = word.slice(1); quoteFunc = Dbrelay.Util.quoteDoubles; };
	      if ( params[word] ) {
	        return ( quoteFunc ? quoteFunc( params[word] ) : params[word] );
	      } else {
	        return '';
	      };
	    });
	  },
	
	//private
		get_params : function( query ){
	    var matches = query.match(param_re);
	    for (var m in matches){ 
				if(typeof(matches[m]) !== 'string'){ continue};

	      matches[m] = matches[m].replace(divid_re, '');
	    };
	    return matches;
	  }
	
	};

	<div id="cls-DbRelay.adapters.BaseAdapter"></div>/** 
	@class DbRelay.adapters.BaseAdapter
	Abstract base class for different database types.  This class should not be used directly.
	*/
	DbRelay.adapters.BaseAdapter = function(name, queries){
		this.name = name;
		this.queries = queries;
		
		return this;
	};
	DbRelay.adapters.BaseAdapter.prototype = {
		//private
		get : function(name, params){
			if(!this.queries[name]){
			  //alert('"'+name+'" is not supported for Adapter ' + this.name); 
				return null;
			}
			return DbRelay.cook( this.queries[name], params || {} );
			
		}
	};
	
	<div id="cls-DbRelay.adapters.SqlServer"></div>/** 
	@class DbRelay.adapters.SqlServer
	@extends DbRelay.adapters.BaseAdapter
	@singleton
	Query Adapter class for Sql Server. Contains SQL Server specific query syntax required for the DBRelay UI
	*/
	DbRelay.adapters.SqlServer = new DbRelay.adapters.BaseAdapter('SqlServer', {
			list_databases:"USE MASTER;SELECT NAME FROM sys.sysdatabases ORDER BY NAME ASC",
			/* Db actions */
			create_table :"create table {{{table}}} {{{columns}}}",
			drop_table :"drop table {{{table}}}",
			commit_transaction : "BEGIN TRANSACTION "
					+"BEGIN TRY "
					+" {{{statements}}} "
					+"    COMMIT TRANSACTION "
					+"END TRY "
					+"BEGIN CATCH "
					+"   ROLLBACK TRANSACTION "
					+"END CATCH",  
			get_rowcounts:"SELECT t.name, sum(p.rows) as [rows] "
					+"FROM   sys.tables t "
					+"JOIN   sys.indexes i "
					+"ON     t.object_id = i.object_id "
					+"JOIN   sys.partitions p "
					+"ON     i.object_id = p.object_id "
					+"AND    i.index_id = p.index_id "
					+"WHERE  i.index_id in (0,1) "
					+"group by t.name "
					+"ORDER BY SUM(P.ROWS) DESC",
			get_columncounts:"SELECT TABLE_NAME, COUNT(COLUMN_NAME) as 'columns' FROM INFORMATION_SCHEMA.COLUMNS GROUP BY TABLE_NAME ",
			/* generic Table specific actions */
		  fetch_all_rows: "select * from {{{table}}}",
			fetch_rows: "select {{{columns}}} from {{{table}}}\n {{{where}}} \n{{{orderBy}}}",
			get_count:	"SELECT COUNT({{{columns}}}) FROM {{{table}}} \n{{{where}}}",
			row_add:"INSERT INTO {{{table}}} {{{columns}}} VALUES {{{values}}}",  
			delete_row: "DELETE FROM {{{table}}} WHERE \n{{{where}}}",
			fetch_paged_rows: "select * from ("
				+" Select ROW_NUMBER () OVER(Order By \n{{{orderBy}}}) \nas dbrelayRowNum, *"
				+"  From (SELECT * FROM {{{table}}} \n{{{where}}}) \ndbrelayInnerp1"
				+" ) dbrelayInnerp2"
				+" WHERE dbrelayRowNum BETWEEN {{{minRow}}} and {{{maxRow}}}",
		 	update_row :"UPDATE {{{table}}} SET {{{setvalues}}} WHERE \n{{{where}}}"
	});
	
	
	/** @ignore
	DbRelay.BatchManager
	*/
	DbRelay.BatchManager = function(){
		//keyed by batch name
		this.queries = {};
	};
	
	DbRelay.BatchManager.prototype = {
		push: function( name, query ){
      if ( this.queries[ name ] ) {
        this.queries[ name ] += ";\n" + query;
      } else {
        this.queries[ name ] = query;
      };
    },
    
    empty: function( name ) {
      try{
        delete( this.queries[ name ] );
      }
			catch(e){}
    },
    
		//non-existent batch returns null
    get: function( name ){
			return this.queries[ name ] || null;
    }

		
	};
	


})();


/* Legacy */

dbrelayQuery = function( connection, sql, callback, query_tag) {
  DbRelay.query(connection, sql, callback, null, window, query_tag);
}; 

dbrelayStatus = function(callback, dbrhost) {
	DbRelay.queryStatus(callback, window, dbrhost); 
};
    
dbrelayKillConnection = function(sockpath, callback, dbrhost) {
	DbRelay.kill(sockpath, callback, window, dbrhost);
};

sqlObject = function(connection, sql_queries) {
	connection.sql_type = connection.sql_type || 'sqlserver';
	return new DbRelay.QueryHelper(connection);
};



</pre>    
</body>
</html>