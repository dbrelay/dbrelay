
function dbrelayQuery(connection,sql,callback,query_tag){var params={sql:sql,query_tag:query_tag||null};for(var k in connection){if(k!=='dbrelay_host'){params[k]=connection[k];}}
if(connection.dbrelay_host){jQuery.getJSON(connection.dbrelay_host+'/sql?js_callback=?',params,callback);}
else{$.post('/sql',params,callback,"json");}};function dbrelayStatus(callback,dbrhost){var params={status:1};if(dbrhost){jQuery.getJSON(dbrhost+'/sql?js_callback=?',params,callback);}
else{$.post('/sql',params,callback,"json");}};function dbrelayKillConnection(sockpath,callback,dbrhost){var params={cmd:'kill',param1:sockpath};if(dbrhost){jQuery.getJSON(dbrhost+'/sql?js_callback=?',params,callback);}
else{$.post('/sql',params,callback,"json");}};sqlObject=function(){function throwError(name,message,body,hard){if(window.console&&window.console.error){console.error({"name":name,"message":message,"body":body});};alert(message)
if(hard){throw{"name":name,"message":message,"body":body};};};var param_re=/{{{([""'']?\w+)}}}/g;var divid_re=/({{{[\'\"]?)|(}}})/g;var batches={queries:{},push:function(name,query){if(this.queries[name]){this.queries[name]+=";\n"+query;}else{this.queries[name]=query;};},empty:function(name){if(this.queries[name]){delete(this.queries[name]);};},get:function(name){if(this.queries[name]){return this.queries[name];}else{throwError("Non-existent batch","Non-existent batch "+name,null,true);};}};function quoteSingles(text){return text.replace(/'/g,"''");};function quoteDoubles(text){return text.replace(/"/g,'""');};function cook(string,params){return string.replace(param_re,function(match,word){var quoteFunc=undefined;if(word.charAt(0)=="'"){word=word.slice(1);quoteFunc=quoteSingles;};if(word.charAt(0)=='"'){word=word.slice(1);quoteFunc=quoteDoubles;};if(params[word]){return(quoteFunc?quoteFunc(params[word]):params[word]);}else{return'';};});};function get_params(query){var matches=query.match(param_re);for(m in matches){if(typeof(matches[m])!=='string')continue;matches[m]=matches[m].replace(divid_re,'');};return matches;};return function(connection,sql_queries){function exec(query,callback,tag){dbrelayQuery(connection,query,function(response){if(response.log.error){throwError("sqlError",response.log.error,{request:response.request,log:response.log});};if(callback){callback(response);}},tag);};var sqlObjectConstructor=function(){for(action in sql_queries){var action_body=sql_queries[action];if(typeof(action_body)=="string"){this.add_query(action,action_body);}else if(Object.prototype.toString.apply(action_body)=="[object Array]"&&action_body.length==2&&typeof(action_body[0])=='string'&&typeof(action_body[1])=='function'){this.add_query(action,action_body[0],action_body[1]);}else{var err=new Error();err.name="ArgumentError";err.message="Wrong paramaters. Expected either a string or an array of a string and a callback.";throw err;};};};sqlObjectConstructor.prototype={empty_batch:function(name){batches.empty(name);},verbs:function(){var verbs={};for(action in this){if(this.hasOwnProperty(action)){verbs[action]=this[action];};};return verbs;},add_query:function(action_name,action_body,default_callback){var that=this;this[action_name]=function(act_name,act_query){return function(params,callback_or_batch,tag){if(params&&typeof(params)=="object"){query=cook(act_query,params);}else{query=act_query;callback_or_batch=params;params=null;};if(callback_or_batch){if(typeof(callback_or_batch)=="function"){exec(query,callback_or_batch,tag);}else{batches.push(callback_or_batch,query);};}else{exec(query,that[act_name].callback,tag);};};}(action_name,action_body);this[action_name].parameters=get_params(action_body);if(typeof(default_callback)=='function'){this[action_name].callback=default_callback;};},run_batch:function(batch_name,callback){exec(batches.get(batch_name),callback,this);batches.empty(batch_name);},get_batch:function(batch_name){return batches.get(batch_name);}};return(new sqlObjectConstructor());};}();sqlDbAccess=function(){return function(connection){var _log=[];var _sqlDbAccess=function(){var cn=connection.connection_name;connection.connection_name=(cn&&cn!=='')?cn:'';connection.flags=connection.flags||'';this.so=sqlObject(connection,{list_databases:["USE MASTER;SELECT NAME FROM sys.sysdatabases",this._onVerb],create_table:["create table {{{table}}} {{{columns}}}",this._onVerb],drop_table:["drop table {{{table}}}",this._onVerb],commit_transaction:["BEGIN TRANSACTION "
+"BEGIN TRY "
+" {{{statements}}} "
+"    COMMIT TRANSACTION "
+"END TRY "
+"BEGIN CATCH "
+"   ROLLBACK TRANSACTION "
+"END CATCH",this._onVerb],get_rowcounts:["SELECT t.name, sum(p.rows) as [rows] "
+"FROM   sys.tables t "
+"JOIN   sys.indexes i "
+"ON     t.object_id = i.object_id "
+"JOIN   sys.partitions p "
+"ON     i.object_id = p.object_id "
+"AND    i.index_id = p.index_id "
+"WHERE  i.index_id in (0,1) "
+"group by t.name "
+"ORDER BY SUM(P.ROWS) DESC",this._onVerb],get_columncounts:["SELECT TABLE_NAME, COUNT(COLUMN_NAME) as 'columns' FROM INFORMATION_SCHEMA.COLUMNS GROUP BY TABLE_NAME ",this._onVerb],fetch_all_rows:["select * from {{{table}}}",this._onVerb],fetch_rows:["select {{{columns}}} from {{{table}}} {{{where}}} {{{orderBy}}}",this._onVerb],get_count:["SELECT COUNT({{{columns}}}) FROM {{{table}}} {{{where}}}",this._onVerb],row_add:["INSERT INTO {{{table}}} {{{columns}}} VALUES {{{values}}}",this._onVerb],delete_row:["DELETE FROM {{{table}}} WHERE {{{where}}}",this._onVerb],fetch_paged_rows:["select * from ("
+" Select ROW_NUMBER () OVER(Order By {{{orderBy}}}) as dbrelayRowNum, *"
+"  From (SELECT * FROM {{{table}}} {{{where}}}) dbrelayInnerp1"
+" ) dbrelayInnerp2"
+" WHERE dbrelayRowNum BETWEEN {{{minRow}}} and {{{maxRow}}}",this._onVerb],update_row:["UPDATE {{{table}}} SET {{{setvalues}}} WHERE {{{where}}}",this._onVerb]});}
_sqlDbAccess.prototype={connection:connection,run:function(verb,cfg,success,error,scope){if(!this.so[verb]){alert('"'+verb+'" is not a valid action.');return;}
this.so[verb].call(window,cfg||{},function(results){if(results.data){if(success){success.call(scope||window,results);}
_log.push('<p style="color:blue">'+results.log.sql+'</p>');}
else{if(error){error.call(scope||window,results,results.log.error);}
_log.push('<p style="color:red">FAIL: ('+(results.log.error||'Unknown Reason')+')'+results.log.sql+'</p>');}});},getLog:function(){return _log;},clearLog:function(){_log=[];},getDatabases:function(success,error,scope){this.run('list_databases',{},function(resp){if(resp.data.length===2){var dbs=[],rows=resp.data[1].rows;for(var i=0,len=rows.length;i<len;i++){dbs.push(rows[i].NAME);}
if(success){success.call(scope||window,this,dbs);}}
else{if(error){error.call(scope||window,this,resp,"sqlDbAccess.getDatabases > Data was missing");}}},function(resp,err){if(error){error.call(scope||window,this,resp,err);}},scope);},testConnection:function(callback,scope){this.getAllRowCounts(function(dba,resp){if(callback){callback.call(scope||window,this,true);}},function(dba,resp){if(callback){callback.call(scope||window,this,false);}},this);},setFlag:function(flag,on){var flags=this.connection.flags+',',isInFlags=flags.indexOf(flag+',')!==-1;if(on){if(!isInFlags){this.connection.flags+=','+flag;}}
else{if(isInFlags){this.connection.flags=flags.replace(flag+',','');}}},executeSql:function(sql,flags,success,error,scope){var params={};for(var x in this.connection){params[x]=this.connection[x];}
if(flags){params.flags=params.flags||'';for(var i=0;i<flags.length;i++){params.flags+=','+flags[i];}}
dbrelayQuery(params,sql,function(resp){if(resp.data){_log.push('<p style="color:blue">'+resp.log.sql+'</p>');if(success){success.call(scope||window,this,resp);}}
else{_log.push('<p style="color:red">FAIL: ('+(resp.log.error||'Unknown Reason')+')'+resp.log.sql+'</p>');if(error){error.call(scope||window,this,resp,resp.log.error);}}});},commitBatchTransaction:function(batch,callback,scope){this.commitTransaction(this.getBatch(batch),callback,scope);},getBatch:function(batch){return this.so.get_batch(batch);},emptyBatch:function(batch){this.so.empty_batch(batch);},commitTransaction:function(statements,callback,scope){this.run('commit_transaction',{statements:statements},function(resp){if(callback){callback.call(scope||window,this,resp);}},null,this);},getAllRowCounts:function(callback,errorfn,scope){this.run('get_rowcounts',{},function(resp){if(resp.data){var rows=resp.data[0].rows,countObj={};for(var i=0;i<rows.length;i++){var row=rows[i];countObj[row.name]=row.rows;}
if(callback){callback.call(scope||window,this,resp,countObj);}}
else{if(errorfn){errorfn.call(scope||window,this,resp);}}},null,this);},getAllCellCounts:function(callback,errorfn,scope){this.getAllRowCounts(function(sqld,resp,rowcounts){this.run('get_columncounts',{},function(colresp){if(resp.data){var rows=colresp.data[0].rows,cellCounts={};for(var i=0;i<rows.length;i++){var row=rows[i];cellCounts[row.TABLE_NAME]=rowcounts[row.TABLE_NAME]*row.columns;}
if(callback){callback.call(scope||window,this,resp,cellCounts);}}
else{if(errorfn){errorfn.call(scope||window,this,resp);}}},null,this);},function(sqld,resp){if(errorfn){errorfn.call(scope||window,this,resp);}},this);},adminQuery:function(params,success,error,scope){for(var k in this.connection){if(k!=='dbrelay_host'&&k!=='sql'){params[k]=this.connection[k];}}
var dbrhost=this.connection.dbrelay_host;if(dbrhost){jQuery.getJSON(dbrhost+'/sql?js_callback=?',params,function(data){if(success){success.call(scope||window,data);}});}
else{$.post('/sql',params,function(data){if(success){success.call(scope||window,data);}},"json");}},getTables:function(callback,scope){this.adminQuery({cmd:'tables'},function(resp){var rows=resp.data[0].rows,tableNames=[];for(var i=0;i<rows.length;i++){tableNames[i]=rows[i].TABLE_NAME;}
if(callback){callback.call(scope||window,this,resp,tableNames);}},this);},createTable:function(table,columns,callback,scope){this.run('create_table',{table:table,columns:'('+columns+')'},function(resp){if(callback){callback.call(scope||window,resp);}},null,this);},dropTable:function(table,callback,scope){this.run('drop_table',{table:table},callback,null,scope);},_onVerb:function(results){}}
return new _sqlDbAccess();}}();sqlTable=function(){return function(table,sqlDb){var _sqlTable=function(){this.sqlDb=sqlDb.connection?sqlDb:new sqlDbAccess(sqlDb);};_sqlTable.prototype={queryColumns:function(callback,error,scope){this.sqlDb.adminQuery({cmd:'columns',param1:table},function(resp){if(!resp||!resp.data){return;}
var data=resp.data[0],count=data.count,rows=data.rows,columns=[];for(var i=0,len=rows.length;i<len;i++){var col=rows[i];columns[i]={name:col.COLUMN_NAME,required:col.IS_NULLABLE==='NO'?false:true,dataType:col.DATA_TYPE};}
this.tableColumns=columns;if(callback){callback.call(scope||window,this,resp,columns);}},function(resp){if(error){error.call(scope||window,this,resp);}},this);},fetchAll:function(callback,scope){this.fetchRows(null,callback,scope);},fetchRows:function(cfg,callback,scope){cfg=cfg||{};this.sqlDb.run('fetch_rows',{table:table,columns:cfg.columns||'*',where:cfg.where?('WHERE '+cfg.where):'',orderBy:cfg.orderBy?'ORDER BY '+cfg.orderBy:''},function(results){if(callback){callback.call(scope||window,this,results);}},null,this);},fetchPagingRows:function(cfg,callback,error,scope){cfg=this.applyProperties(cfg||{},{columns:'*',recordStart:0,pagingSize:20,where:''});if(!cfg.orderBy){if(!this.tableColumns){this.queryColumns(function(sqlt,resp,columns){if(resp&&resp.data){cfg.orderBy=columns[0].name+' asc';this.fetchPagingRows(cfg,callback,error,scope);}},function(sqlt,err){if(error){error.call(scope||window,this,err);}},this);return;}
else{cfg.orderBy=this.tableColumns[0].name+' asc';}}
if(typeof(cfg.recordStart)!=='number'||typeof(cfg.pagingSize)!=='number'){alert('recordStart and pagingSize should be numeric');return{};}
this.sqlDb.run('fetch_paged_rows',{columns:cfg.columns,where:cfg.where?'WHERE '+cfg.where:'',orderBy:cfg.orderBy,table:table,minRow:cfg.recordStart+'',maxRow:cfg.recordStart+cfg.pagingSize},function(results){if(callback){callback.call(scope||window,this,results,cfg);}},null,this);},addRows:function(rows,callback,scope){var batch=this.setAddRowsBatch(rows);if(!batch){return;}
sqlDb.commitBatchTransaction(batch,function(sdb,resp){sqlDb.emptyBatch(batch);if(callback){callback.call(scope||window,this,resp);}},this);},setAddRowsBatch:function(rows){if(rows.length===0){return false;}
var batch='add'+new Date().getTime();for(var i=0,len=rows.length;i<len;i++){var row=rows[i],values=[],columns=[];for(var k in row){values.push("'"+row[k].replace(/'/g,"\'")+"'");columns.push(k);}
sqlDb.so.row_add({table:table,columns:'('+columns.join(',')+')',values:'('+values.join(',')+')'},batch);}
return batch;},safeSqlString:function(s){return"'"+s.replace(/'/g,"''")+"'";},deleteRows:function(rows,callback,scope){var batch=this.setDeleteRowsBatch(rows);if(!batch){return;}
sqlDb.commitBatchTransaction(batch,function(sdb,resp){sqlDb.emptyBatch(batch);if(callback){callback.call(scope||window,this,resp);}},this);},setDeleteRowsBatch:function(rows){if(rows.length===0){return false;}
var batch='delete'+new Date().getTime();for(var i=0,len=rows.length;i<len;i++){var row=rows[i],wheres=[];for(var k in row){wheres.push(k+"="+this.safeSqlString(row[k]))}
sqlDb.so.delete_row({table:table,where:'('+wheres.join(' AND ')+')'},batch);}
return batch;},updateRows:function(set,wheres,callback,scope){var batch=this.setUpdateRowsBatch(set,wheres);if(!batch){return;}
sqlDb.commitBatchTransaction(batch,function(sdb,resp){sqlDb.emptyBatch(batch);if(callback){callback.call(scope||window,this,resp);}},this);},setUpdateRowsBatch:function(set,wheres){if(set.length===0){return false;}
var batch='update'+new Date().getTime();for(var i=0,len=set.length;i<len;i++){var values=set[i],valueparam=[],where='';for(var col in values){valueparam.push(col+"="+this.safeSqlString(values[col]));}
var wherecols=wheres[i];if(typeof(wherecols)==='string'){where=wherecols;}
else{var whereparam=[];for(var k in wherecols){whereparam.push(k+"="+this.safeSqlString(wherecols[k]));}
where=whereparam.join(' AND ');}
sqlDb.so.update_row({table:table,setvalues:valueparam.join(','),where:where},batch);}
return batch;},queryPrimaryKeys:function(callback,error,scope){this.sqlDb.adminQuery({cmd:'pkey',param1:table},function(resp){var rows=resp.data[0].rows,keys=[];for(var i=0;i<rows.length;i++){keys[i]=rows[i].COLUMN_NAME;}
this.pkeyColumns=keys;if(callback){callback.call(scope||window,this,resp,keys);}},function(resp){if(error){error.call(scope||window,this,resp);}},this);},queryTotalRows:function(cfg,callback,scope){cfg=cfg||{};var where=cfg.where||{},whereparam=[];if(typeof(where)==='string'){whereparam='WHERE '+where;}
else{for(var w in where){whereparam.push(k+"="+this.safeSqlString(where[w]));}
whereparam=whereparam.length===0?'':'WHERE '+whereparam.join('AND')}
this.sqlDb.run('get_count',{table:table,columns:cfg.pkeys||'*',where:whereparam},function(resp){if(resp.data){var total=resp.data[0].rows[0][1];if(callback){callback.call(scope||window,this,resp,total);}}},null,this);},applyProperties:function(dest,src,overwrite){dest=dest||{};for(var p in src){if(overwrite||!dest[p]){dest[p]=src[p];}}
return dest;}};return new _sqlTable();}}();