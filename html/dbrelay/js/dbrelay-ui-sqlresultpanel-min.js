
Ext.namespace('dbrui');dbrui.SqlSelectGrid=Ext.extend(Ext.grid.GridPanel,{viewConfig:{forceFit:true,autoFill:true,emptyText:'Empty result set',deferEmptyText:false},border:false,pageSize:50,pageNumber:1,totalPages:1,initComponent:function(){var idpfx=Ext.id();this.tbar=['<span id="name'+idpfx+'" style="font-weight:bold;color:green">Viewing '+(this.resultName||'')+'</span>','->',{text:'Export',iconCls:'icon-tableexport',menu:[{text:'All rows as HTML',iconCls:'icon-html',handler:function(){this.exportHtml(true);},scope:this},{text:'Selected rows as HTML',iconCls:'icon-html',handler:function(){this.exportHtml(false)},scope:this},'-',{text:'All rows as CSV',iconCls:'icon-excel',handler:function(){this.exportCSV(true);},scope:this},{text:'Selected rows as CSV',iconCls:'icon-excel',handler:function(){this.exportCSV(false);},scope:this}]},'-','<span id="total'+idpfx+'"></span> total','-',{xtype:'numberfield',id:'pagesize'+idpfx,width:30,enableKeyEvents:true,selectOnFocus:true,listeners:{'blur':{fn:this.updatePageView,scope:this},'keyup':{fn:function(b,e){if(e.keyCode===e.ENTER){this.updatePageView();}},scope:this}}},'/page','-',{iconCls:'icon-first',handler:function(){this.showPage(1);},scope:this},{iconCls:'icon-back',handler:function(){var page=this.pageNumberField.getValue();this.showPage(page===1?1:page-1);},scope:this},'Page',{xtype:'numberfield',id:'page'+idpfx,width:30,enableKeyEvents:true,selectOnFocus:true,listeners:{'blur':{fn:this.updatePageView,scope:this},'keyup':{fn:function(b,e){if(e.keyCode===e.ENTER){this.updatePageView();}},scope:this}}},'of <span id="totalPages'+idpfx+'"></span>',{iconCls:'icon-next',handler:function(){var page=this.pageNumberField.getValue();this.showPage(page===this.totalPages?page:page+1);},scope:this},{iconCls:'icon-last',handler:function(){this.showPage(this.totalPages);},scope:this}];this.store=this.store||new Ext.data.Store();this.cm=this.cm||new Ext.grid.ColumnModel([]);dbrui.SqlSelectGrid.superclass.initComponent.call(this);this.idpfx=idpfx;},refresh:function(data){var cols=data.fields,rows=data.rows;var cmData=[],storeFields=[];for(var i=0,len=cols.length;i<len;i++){var col=cols[i],name=col.name;cmData[i]={header:name,sortable:true,id:name,dataIndex:name};storeFields[i]={name:name,type:'string'};}
var store=new Ext.data.JsonStore({autoDestroy:true,data:{rows:rows},root:'rows',fields:storeFields});var cm=new Ext.grid.ColumnModel(cmData);this.reconfigure(store,cm);this.tableData=rows;this.totalRows=data.count||'0';Ext.get('total'+this.idpfx).update(this.totalRows);this.pageNumberField=Ext.getCmp('page'+this.idpfx);this.pageSizeField=Ext.getCmp('pagesize'+this.idpfx);this.pageNumberField.setValue(this.pageNumber);this.pageSizeField.setValue(this.pageSize);this.updatePageView();},showPage:function(page){this.pageNumberField.suspendEvents();this.pageNumberField.setValue(page);this.pageNumberField.resumeEvents();this.updatePageView();},updatePageView:function(){var pageNumber=this.pageNumberField.getValue();if(pageNumber>this.totalPages){this.pageNumberField.suspendEvents();this.pageNumberField.setValue(this.totalPages);this.pageNumberField.resumeEvents();}
var pageSize=this.pageSizeField.getValue();var start=(pageNumber-1)*pageSize;this.store.loadData({'rows':this.tableData.slice(start,start+pageSize)});this.pageNumber=pageNumber;this.pageSize=pageSize;this.totalPages=Math.floor((this.totalRows/this.pageSize)+1);Ext.get('totalPages'+this.idpfx).update(this.totalPages);},setResultName:function(s){Ext.get('name'+this.idpfx).update(s);this.resultName=s;},exportHtml:function(allRows){var rows=allRows?this.tableData:this.getSelectionModel().getSelections(),html='',cols=[];html='<table>';var cm=this.getColumnModel();var numCols=cm.getColumnCount();html+='<thead><tr>';for(var c=0;c<numCols;c++){if(!cm.isHidden(c)){var cname=cm.getDataIndex(c);cols.push(cname);html+='<th>'+cname+'</th>';}}
html+='</tr></thead><tbody>';for(var i=0,len=rows.length;i<len;i++){html+='<tr>';var row=rows[i];for(var c=0;c<cols.length;c++){html+='<td>'+(allRows?row[cols[c]]:row.data[cols[c]])+'</td>';}
html+='</tr>';}
html+='</tbody></table>';var win=window.open('','','width=600,height=500'
+',menubar=0'
+',toolbar=1'
+',status=0'
+',scrollbars=1'
+',resizable=1');win.document.writeln('<html><head><style>');win.document.writeln('table{width:100%;border-collapse:collapse;padding:0;margin:0;font-family:Arial, Helvetica, "sans serif"}');win.document.writeln('td,th{font-size:11px;text-align:left;border:1px solid black;}');win.document.writeln('</style></head><body>');win.document.writeln(html);win.document.writeln('</body></html>');win.document.close();},exportCSV:function(allRows){var rows=allRows?this.tableData:this.getSelectionModel().getSelections(),csv='',cols=[],temp=[];var cm=this.getColumnModel();var numCols=cm.getColumnCount();function _csv(v){v+="";v=v.replace(/"/g,'"""');return'"'+v+'"';}
for(var c=0;c<numCols;c++){if(!cm.isHidden(c)){var cname=cm.getDataIndex(c);cols.push(cname);temp.push(_csv(cname));}}
csv+=temp.join(',')+'\n';for(var i=0,len=rows.length;i<len;i++){temp=[];var row=rows[i];for(var c=1;c<cols.length;c++){temp.push(_csv(allRows?row[cols[c]]:row.data[cols[c]]));}
csv+=temp.join(',')+'\n';}
var win=window.open('','','width=600,height=500'
+',menubar=0'
+',toolbar=1'
+',status=0'
+',scrollbars=1'
+',resizable=1');win.document.writeln(csv);win.document.close();Ext.Msg.alert('CSV Generated in Popup Window','Save popup window as .csv file');}});Ext.namespace('dbrui');dbrui.SqlResultPanel=Ext.extend(Ext.Panel,{cls:'dbr-sqlresultpanel',iconCls:'icon-sql',layout:'border',closable:true,directLink:true,initComponent:function(){var idpfx=Ext.id();this.cm=new Ext.grid.ColumnModel([]);this.store=new Ext.data.Store();this.grids=[];this.tbar=[{text:'Hide Query',iconCls:'icon-app',enableToggle:true,pressed:true,handler:function(b,e){var hidden=this.northRegion.hidden;b.setText(hidden?'Hide Query':'Show Query');b.setIconClass(hidden?'icon-app':'icon-app-split');this.northRegion.setVisible(hidden);this.doLayout();},scope:this},'-',{text:'Run (CTRL + Enter)',iconCls:'icon-tick',tooltip:'Execute SQL [Shift + Enter]',handler:this.execSql,scope:this},'->',{iconCls:'icon-minus',text:'Clear',handler:function(){this.fldSqlCode.setValue('');this.fldUrl.setValue('');this.showMsgPanel('Enter query to execute.');},scope:this}];this.items=[{region:'north',height:120,split:true,collapsible:true,layout:'form',unstyled:true,labelWidth:80,id:'north'+idpfx,items:[{fieldLabel:'SQL',xtype:'textarea',id:'sqlcode'+idpfx,anchor:'98%',allowBlank:false,enableKeyEvents:true,selectOnFocus:true,value:this.defaultSql||'',listeners:{'keyup':{fn:function(fld,e){if(e.ctrlKey&&e.keyCode===e.ENTER){this.execSql();}},scope:this}}},{xtype:'checkbox',boxLabel:'Execute as a single Transaction',id:'xact'+idpfx},{xtype:'displayfield',fieldLabel:'',id:'url'+idpfx,style:'font-size:10px;'}],listeners:{'resize':{fn:function(p,aw,ah){var offset=this.directLink?60:30;this.fldSqlCode.setHeight(ah-offset);},scope:this},'expand':{fn:function(p){p.doLayout();}}}},{region:'center',id:'resultsRegion'+idpfx,border:false,layout:'card',activeItem:0,items:{id:'msg'+idpfx,unstyled:true},tbar:[{text:''}]}];dbrui.SqlResultPanel.superclass.initComponent.call(this);this.fldSqlCode=this.findById('sqlcode'+idpfx);this.msgPanel=this.findById('msg'+idpfx);this.fldUrl=this.findById('url'+idpfx);this.fldXact=this.findById('xact'+idpfx);this.northRegion=Ext.getCmp('north'+idpfx);this.centerRegion=Ext.getCmp('resultsRegion'+idpfx);this.idpfx=idpfx;},execSql:function(){if(!this.fldSqlCode.validate()){return;}
this.centerRegion.body.mask();this.sqlDb.executeSql(this.fldSqlCode.getValue(),(this.fldXact.getValue()?['xact']:null),function(sqld,resp){if(resp.log.error||!resp.data){this.showMsgPanel('<p style="color:red">Error:</p><pre style="color:red">'+resp.log.error+'</pre>');this.centerRegion.body.unmask();}
else{var data=resp.data[0];if(data.fields.length===0){this.showMsgPanel('<p style="color:green">Success: '+data.count+' rows affected.</p>');this.centerRegion.body.unmask();}
else{this.showResultGrids(resp.data);}
var conn=Ext.apply({},this.sqlDb.connection);conn.sql=this.fldSqlCode.getValue();conn.query_tag=null;conn.sql_password=null;if(this.fldXact.getValue()){conn.flags+=',xact';}
var sqlUrl=window.location.protocol+'//'+window.location.host+window.location.pathname+'?'
+Ext.urlEncode(conn)+'&'+window.location.hash;this.setUrlLink(sqlUrl);}},function(sqld,resp,err){Ext.Msg.alert('Error',err);},this);},setUrlLink:function(url){if(this.directLink){this.fldUrl.setValue('<a href="'+url+'" target="_blank">'+url+'</a>');}},showMsgPanel:function(msg){this.centerRegion.getLayout().setActiveItem(this.msgPanel);this.msgPanel.body.update(msg);},showResultGrids:function(dataSets){var tb=this.centerRegion.getTopToolbar(),numResults=dataSets.length,count=0;tb.removeAll();for(var i=0;i<numResults;i++){var data=dataSets[i];if(!data.count&&data.count!==0){continue;}
var name='Result Set '+(count+1);if(!this.grids[count]){var grid=new dbrui.SqlSelectGrid({resultName:'Viewing '+name,dataSet:data,listeners:{'render':{fn:function(g){this.doLayout();g.refresh(g.dataSet);delete g.dataSet;},scope:this}}});this.centerRegion.add(grid);this.grids[count]=grid;}
else{var grid=this.grids[count];grid.refresh(data);grid.setResultName(name);}
tb.add({text:name,gridIndex:count,id:'showgrid-'+count+this.idpfx,iconCls:'icon-sql',enableToggle:true,enableDepress:false,toggleGroup:'grids'+this.idpfx,toggleHandler:function(b,st){if(st){this.centerRegion.getLayout().setActiveItem(this.grids[b.gridIndex]);this.centerRegion.doLayout();}},scope:this});tb.addText('&nbsp;&nbsp;');count++;}
tb.el.removeClass('x-toolbar');this.doLayout();tb.findById('showgrid-0'+this.idpfx).toggle(true);tb.addText('&nbsp;&nbsp;'+count+' result set'+(count>1?'s':'')+' returned.');this.centerRegion.body.unmask();}});Ext.reg('va_sqlresultpanel',dbrui.SqlResultPanel);