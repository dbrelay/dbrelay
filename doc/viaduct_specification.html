<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
  <head>
  	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  	<title>Viaduct project specifications</title>
  	<style type="text/css" media="print">
  	  body {
  	    font-size: 80%;
  	  }
      #content_wrap {
        width: 95%;
        margin: auto;
        margin-bottom: 20px;
      }
      #toc { display: none; }
      a {
        color: #000000;
        text-decoration: none;
      }
      #revisions_show, #revisions_hide {
        display: none;
      }
  	</style>
  	<style type="text/css" media="screen">
      #revisions_show, #revisions_hide {
        text-decoration: underline;
        cursor: pointer;
      }
      #content_wrap {
        width: 70%;
        margin: auto;
      }
      #toc {
        float: right;
        background-color: white;
        padding: 1em;
        margin: 0em 0em 1em 1em;
        border: 1px solid #bbbbbb;
        max-width: 15em;
      }
      #toc_show, #toc_hide {
        float: right;
        cursor: pointer;
      }
      #toc a {
        color: #000000;
      }
      #toc ol {
        padding-left: 1.2em;
      }
      a {
        color: #555555;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
  	</style>
  	<style type="text/css">
  	  body {
  	    font-family: sans-serif;
      }
      .copyright {
        text-align: center !important;
        font-size: 80%;
        color: #555;
      }
      div.float_break {
        clear: left;
      }
      .chapter > ul {
        min-width: 30em;
        margin: 0em auto 0em 5%;
      }
      .chapter > ul > li {
        margin-top: 1.5em;
      }
      .chapter p {
        text-align: justify;
      }
      li > ul > li {
        margin-top: 0.3em;
      }
      .date {
        width: 6em;
        text-align: right;
        background-color: #eee;
      }
      .person {
        width: 10em;
        text-align: center;
        background-color: #eee;
      }
      .comments {
        text-align: justify;
      }
      h1, h2, h3, h4 {
        margin-top: 1.5em;
        color: #444;
      }
      h1 {
        text-align: center;
      }
      h2 {
        text-align: right;
        padding-right: 10%;
        border-bottom: 1px solid #222;
      }
      h3 {
        text-align: left;
        padding-left: 5%;
      }
      h4 {
        padding-left: 10%;
        font-weight: normal;
        font-style: italic;
        margin-top: 2em;
      }
      todo {
        display: inline;
        border: 2px solid #2900A6;
        padding: 0em 0.15em;
        margin: -1px 0.15em;
      }
      .em {
        font-variant: small-caps;
        font-weight: bold;
      }
      div.error_note {
        float: right;
        padding: 0.3em;
        border: 1px solid #AAAAAA;
        margin-left: 1em;
        margin-bottom: 0.5em;
        font-size: 70%;
      }
      table {
        border-collapse: collapse;
      }
      td {
        border: 1px solid #AAAAAA;
        padding: 0.2em 0.5em;
        vertical-align: top;
      }
      p > .term {
        text-align: left;
        background-color: #eee;
        min-width: 8em;
      }
      .term {
        display: block;
        float: left;
        margin: 0em 0.5em 0.2em 0em;
        padding: 0.2em 0.5em;
        clear: left;
      }
      .spec {
        font-family: monospaced;
        margin-left: 10em;
      }
      .spec > .term {
        margin-left: -10em;
        text-align: right;
        width: 9em;
        padding: 0em 0.5em 0em 0em !important;
        background: none;
      }
      code {
        font-size: 80%;
      }
      .ab {
        font-style: italic;
        font-variant: small-caps;
      }
      .json_term {
        text-decoration: underline;
      }
      .indent {
        padding: 0em 1.5em;
        display: block;
      }
      pre {
        font-size: 80%;
        overflow: auto;
        padding-left: 5%;
      }
      p.end_mark {
        text-align: center;
        font-size: 200%;
        color: #555555;
        padding-top: 1em;
      }
      ul.dense, ul.dense li {
        pagging-top: 0;
        pagging-bottom: 0;
        margin-top: 0;
        margin-bottom: 0;
      }
      .done {
        border: 1px solid #42BE30;
      }
      .todo {
        border: 1px solid #F9DB58;
      }
    </style>
  </head>
  <body>
    <div id="content_wrap">
      <div id="toc">
        <div id="toc_show" onclick="
          document.getElementById('toc_show').style.display = 'none';
          document.getElementById('toc_hide').style.display = '';
          document.getElementById('toc_list').style.display = '';
        ">&oplus;</div>
        <div id="toc_hide" onclick="
          document.getElementById('toc_show').style.display = '';
          document.getElementById('toc_hide').style.display = 'none';
          document.getElementById('toc_list').style.display = 'none';
        " style="display: none;">&otimes;</div>
        <ol id="toc_list" style="display: none;">
          <li><a href="#revisions">Revisions</a></li>
          <li><a href="#overview">Overview</a></li>
          <li><a href="#features">Features</a>
            <ol>
              <li><a href="#client_facing">Client-facing interface</a></li>
              <li><a href="#database_facing">Server-facing interface</a></li>
              <li><a href="#system">System interface</a></li>
              <li><a href="#datatypes">Data types conversion</a></li>
            </ol>
          </li>
          <li><a href="#logic">Interaction logic</a>
            <ol>
              <li><a href="#normal_request">Normal request</a></li>
              <li><a href="#persistence">Persistense considerations</li>
              <li><a href="#status_request">Status request</a></li>
              <li><a href="#app_shutdown">Application shutdown</a></li>
            </ol>
          </li>
          <li><a href="#interfaces">Interfaces</a>
            <ol>
              <li><a href="#http_request">HTTP request</a>
                <ol>
                  <li><a href="#http_request_db">Database server</a></li>
                  <li><a href="#http_request_conn">Connection lifecycle</a></li>
                  <li><a href="#http_request_query">SQL query</a></li>
                  <li><a href="#http_admin_request">Administrative requests</a></li>
                </ol>
              </li>
              <li><a href="#http_response">HTTP response (JSON)</a></li>
              <li><a href="#log_files">Log and PID files</a></li>
              <li><a href="#static_files">Static files</a></li>
              <li><a href="#runtime_files">Run time files</a></li>
              <li><a href="#command_line">Command line parameters</a></li>
            </ol>
          </li>
          <li><a href="#environment">Environment</a></li>
          <li><a href="#examples">Example</a></li>
        </ol>
      </div>
      <div id="title" class="chapter">
        <h1>Viaduct specifications</h1>
        <p class="copyright">&copy; 2008 GETCO LLC. All Rights Reserved.</p>
      </div>
      <div id="revisions" class="chapter">
        <h2><span id="revisions_show" onclick="
          document.getElementById('revisions_show').style.display = 'none';
          document.getElementById('revisions_hide').style.display = '';
          document.getElementById('revisions_body').style.display = '';
        ">Show</span><span id="revisions_hide" style="display:none;" onclick="
          document.getElementById('revisions_show').style.display = '';
          document.getElementById('revisions_hide').style.display = 'none';
          document.getElementById('revisions_body').style.display = 'none';
        ">Hide</span> Revisions</h2>
        <div id="revisions_body" style="display:none;">
          <p>
            <span class="term" class="date">2009.01.09</span>
            <span class="term" class="person">Brian&nbsp;Bruns<br />Vlad&nbsp;Didenko</span>
            <div class="comments">Started the <a href="#http_admin_request">Administrative interface</a> chapter. Corrected and cleaned the SQL parameters specification in <a href="#http_request_query">the HTTP Request</a> section. Introduced the <code>http_keepalive</code> parameter in the <a href="#http_request_conn">Connection lifecycle</a> chapter to address the broken HTTP 1.1 implementation in Python 2.5.x.</div>
            <div class="float_break"></div>
          </p>
          <p>
            <span class="term" class="date">2008.12.02</span>
            <span class="term" class="person">Brian&nbsp;Bruns<br />Vlad&nbsp;Didenko</span>
            <div class="comments">Changed the SQL parameters specification in the <a href="#persistence">Persistence considerations</a> chapter, which has been moved. Clarified the garbage collection route in the <a href="#normal_request">Normal Request</a> section. Changed the start point for calculating connection timeout in the <a href="#http_request_conn">Connection lifecycle</a>.</div>
            <div class="float_break"></div>
          </p>
          <p>
            <span class="term" class="date">2008.11.09</span>
            <span class="term" class="person">Vlad&nbsp;Didenko</span>
            <div class="comments">Clarified queuing and state maintanance for named persistent connections in the <a href="#persistence">Persistence considerations</a> chapter, which has been moved. Clarified the garbage collection route in the <a href="#normal_request">Normal Request</a> section. Changed the start point for calculating connection timeout in the <a href="#http_request_conn">Connection lifecycle</a>.</div>
            <div class="float_break"></div>
          </p>
          <p>
            <span class="term" class="date">2008.10.07</span>
            <span class="term" class="person">Brian&nbsp;Bruns<br />Vlad&nbsp;Didenko</span>
            <div class="comments">The server now required to be both HTTP 1.0 and 1.1 compliant in the <a href="#client_facing">Client-facing interface</a> section to ensure the protocol compatibility with Python&#x27;s urllib2. References to HTTP-bound persistency of database connections has ben removed. One of the reasons is that posts (queries) to different named SQL connections may happen over the same HTTP connection. Other logististics gets much simplier with this as well.</div>
            <div class="float_break"></div>
          </p>
          <p>
            <span class="term" class="date">2008.09.23</span>
            <span class="term" class="person">Vlad&nbsp;Didenko</span>
            <div class="comments">The &laquo;length&raquo; attribute is now required in field specifications. Added an optional &laquo;scale&raquo; attribute for numeric and decimal types.</div>
            <div class="float_break"></div>
          </p>
          <p>
            <span class="term" class="date">2008.09.18</span>
            <span class="term" class="person">Vlad&nbsp;Didenko<br />Richard Glick</span>
            <div class="comments">Adjusted the <code>log_level_scope</code> description in the <a href="#http_request">HTTP request</a> section, and log levels format and meanings in the <a href="#log_files">Log and PID files</a> section to match the <code>syslog</code> RFC. Also, added the mentioning of the <a href="#status_request"><code>status</code></a> request in the <a href="#logic">Intraction logic</a> section.</div>
            <div class="float_break"></div>
          </p>
          <p>
            <span class="term" class="date">2008.09.17</span>
            <span class="term" class="person">Vlad&nbsp;Didenko</span>
            <div class="comments">Removed the <code>status</code> request parameter. Added the <code>log_level_scope</code> request parameter. Modified the way the <code>param</code> request parameter described. Added the &laquo;log_level&raquo; descriptions to the <a href="#log_files">Log and PID files</a> section. Higlighted &laquo;done&raquo; items with green border.</div>
            <div class="float_break"></div>
          </p>
          <p>
            <span class="term" class="date">2008.08.26</span>
            <span class="term" class="person">Vlad&nbsp;Didenko,<br />Brian&nbsp;Bruns</span>
            <div class="comments">Removed the <code>sql_domain</code> request parameter - the domain name can be part of the user name. Change the <a href="#http_response">HTTP response</a> specification to have column metadata returned in a rowset property <code>fields</code> (instead of <code>types</code>) as <code>Array</code> of <code>Hashes</code> (instead of <code>Array</code> of <code>Arrays</code>). Added browser specifications to the <a href="#environment">Environment</a> section. Added the ContentType specification to the <a href="#http_response">HTTP response</a> section. Removed the live upgrade requirement from <a href="#app_shutdown">Application shutdown</a> logic.</div>
            <div class="float_break"></div>
          </p>
          <p>
            <span class="term" class="date">2008.08.13</span>
            <span class="term" class="person">Vlad&nbsp;Didenko</span>
            <div class="comments">Added <code>query_tag</code> to request and response interfaces, Javascript example, changed <code>types</code> format in the response from <code>Object</code> to <code>Array</code> of <code>Arrays</code>.</div>
            <div class="float_break"></div>
          </p>
          <p>
            <span class="term" class="date">2008.08.08</span>
            <span class="term" class="person">Vlad&nbsp;Didenko</span>
            <div class="comments">Interfaces and Environment, refined connection persistense and timeouts.</div>
            <div class="float_break"></div>
          </p>
          <p>
            <span class="term" class="date">2008.08.07</span>
            <span class="term" class="person">Vlad Didenko</span>
            <div class="comments">Initial version: Overview, Features, Interaction Logic</div>
            <div class="float_break"></div>
          </p>
        </div>
      </div>
      <div id="overview" class="chapter">
        <h2>Overview</h2>
        <p>The Viaduct application is a protocol bridge allowing HTTP clients to access to Microsoft&reg; SQL Server databases. The primary goal is to make Microsoft&reg; SQL Server access easy for other (unrelated to this project) software, including Python, JavaScript, and Ruby scripts. That includes simple standards-bases request and data formats as well as the ease of installing, maintaining (log files, configuration, etc.) and managing (starting, stopping, inventorying, etc.) the application.</p>
        <p>The essense of the proposed solution is to have the application to accept HTTP requests containing SQL queries, relay them to specified database server, and return the server's reply back to HTTP client in JSON format.</p>
          <p>The Viaduct application will be built from the existing and newly-developed code. Existing code includes, but not limited to, FreeTDS libraries, Nginx web server, unspecified JSON libraries, and other third-party software components necessary for the application. Code to be newly-developed includes a Nginx module and and Nginx server modifications, needed to &quot;glue&quot; the software components into a monolithic, statically linked application.</p>
        <p>As the Viaduct application planned to be released under an open-source license, all existing code need to have a compatible license as reviewed and decided by GETCO LLC before any work to be done with such existing code.</p>
      </div>
      <div id="features" class="chapter">
        <h2>Features</h2>
        <p>The Viaduct application will have client-facing, database-facing, and system interfaces. When referring to unspecified connections, this document means SQL Server connections as opposed to HTTP connections.</p>
        <div id="client_facing" class="chapter">
          <h3>Client-facing interface</h3>
          <p>On the client-facing interface, the Viaduct application will act as a fully-functional HTTP 1.0 and 1.1 server within the abilities on the current stable Nginx release. Addional SQL Bridge module must be built to address the Viaduct-specific functionality. The following existing code modules must be build into the server:</p>
          <ul>
            <li>Nginx Core
              <ul>
                <li>Main Module - error log, processes, permissions, etc.</li>
                <li>Events Module - epoll, kqueue, select, poll, etc.</li>
              </ul>
            </li>
            <li>Standard HTTP Modules
              <ul>
                <li>HTTP Core Module - ports, locations, error pages, aliases, and other essentials</li>
                <li>Access Module - allow/deny based on IP</li>
                <li>Auth Basic Module - HTTP authentication</li>
                <li>Browser Module - interpret &quot;User-Agent&quot; string</li>
                <li>Charset Module - recode web pages</li>
                <li>Empty GIF Module - serve a 1x1 image from memory</li>
                <li>HTTP Headers Module - set arbitrary response headers</li>
                <li>Log Module - custom access logs</li>
                <li>Rewrite Module - apply regular expressions to request URIs</li>
                <li>UserID Module - issue identifying cookies</li>
              </ul>
            </li>
            <li>Optional HTTP modules (from Nginx codebase)
              <ul>
                <li>SSL Module</li>
                <li>Stub Status Module - view server statistics</li>
              </ul>
            </li>
          </ul>
          <p>Note the absence of HTTP Upstream, AutoIndex, FastCGI, GEO, Gzip, HTTP Referer, Limit Zone, Map, Memcached, Proxy, and SSI standard modules - those must not be build into the Viaduct application.</p>
          <p>If included modules rely on excluded or not mentioned modules, then GETCO LLC will decide if the dependency module should be included or dependant module should be excluded.</p>
          <p>Besides the communications enabled by the existing-code modules, the Viaduct application will accept a specially formatted GET and POST requests containing database connectivity properties, authentication data, and a SQL query to be executed on a database server, and return to the client JSON-formatted result sets. Specifics of the request and response formats are in the <a href="#http_request">Interfaces chapter</a>. The rest of the specification addresses only the features and properties of the SQL bridge module unless mentioned otherwise.</p>
        </div>
        <div id="database_facing" class="chapter">
          <h3>Database-facing interface</h3>
          <p>On the database-facing interface, the Viaduct application will act as a FreeTDS-based client compliant with TDS version 9. It will not initially include the connection pooling. It must support time-limited named persistent connections.</p>
        </div>
        <div id="system" class="chapter">
          <h3>System interface</h3>
          <p>The application must be statically linked into a single (monolithic) executable file without a need for any libraries other than provided by standard initial installations of target operating systems.</p>
          <p>The simpliest way to install and run Viaduct application on a system must be by running it without any parameters. In this case it must come up listening on the HTTP port 80, granted standard system limitations (like user permissions or port unavailable). It should have defaults for all configurable items and not need run-time configuration specified, using defaults specified at compile-time.</p>
          <p>As the next level of configuration, the Viaduct executable must accept optional command-line parameters, including a reference to a full-blown Nginx configuration file. There command-line parameters are detailed in the <a href="#command_line">Interfaces chapter</a>.</p>
        </div>
        <div id="datatypes" class="chapter">
          <h3>Data types conversion</h3>
          <p>The SQL Bridge module will need to do a conversion of data it received in rowsets from a database server. Specifics of which data types are supported and how would they beconverted into JSON to return them to the requesting client will be discussed as the first phase of the project and decided upon by GETCO LLC.
        </div>
      </div>
      <div id="logic" class="chapter">
        <h2>Interaction Logic</h2>
        <p>This is a general outline of the logic to be implemented. As the gevelopment progresses, the specific workflows may nee to be adjusted to address the contracted functionality needs.</p>
        <div id="normal_request" class="chapter">
          <h3>Normal request</h3>
          <ol>
            <li>
              <p><div class="error_note todo">error handler</div>Client request expected to contain all nesessary information to locate and authenticate into the server to run the query as well as the query itself.</p>
            </li>
            <li><p><div class="error_note todo">error handler</div>After receiving the client request, the Viaduct applcation should check the connection management parameters and assign either (a) established or (b) newly created connection to the request.</p></li>
            <li><p><div class="error_note todo">error handler</div>When the request gets a connection assigned, it should queue it's SQL query for execution on that connection. Every query should run in a fresh context, meaning, that <span class="em">no</span> temporary objects or other context information from previous queries on the same connection should be visible and impacting the new query.</p></li>
            <li><p><div class="error_note todo">error handler</div>The resulting datasets should be formatted and returned to the client.</p></li>
            <li>
              <p><div class="error_note todo">error handler</div>There should be a connection &quot;garbage collector&quot; regularly destroying idle database connections. Even if a connection was not yet destroyed, but already past it's &quot;living conditions&quot;, it should not be queueing any new queries, but must finish the pending ones before it will be destroyed.</p>
              <p>As it is implemented now, a connection &laquo;garbage collector&raquo; only runs when there is an incoming viaduct request. In future releases, there may be an independant agent or thread running for administration/cleanup.</p>
            </li>
          </ol>
        </div>
        <div id="persistence" class="chapter">
          <h3>Persistense considerations</h4>
          <p>Connections are persistent beyond the HTTP response if, and only if, a connection name is provided. Multiple connections may persist under the same name, distinguished by other connection parameters. To be reused, persistent connections are referred to by the whole combination of sql_server, sql_port, sql_database, sql_domain, sql_user, sql_password (crypted), connection_name. Those parameters are referred to as <em>connection hash keys</em>. Connection timeout adjusted by each query which sets it. Error style is specific for the query and is not persistent.</p>
          <p>If a request comes to a named connection which is busy with another query, the request should be queued and executed in a FIFO manner. No two connections should match the same set of hash keys. The reason for these two requirements is that named persistent connection may have state, which users may need to maintain and predictably retrieve on named connections.</p>
          <p>Connection parameters are defined below in the <a href="#http_request">HTTP request</a> section, including the details of the <code>connection_timeout</code> parameter.</p>
        </div>
        <div id="status_request" class="chapter">
          <h3>Status request</h3>
          <p>A status report on open connections, loads, timings, memory, version, etc should be available on a configurable URI, <code>/status</code> by default. The <span class="todo">details of the status response</span> will be specified later in the project.</p>
        </div>
        <div id="app_shutdown" class="chapter">
          <h3>Application shutdown</h3>
          <p>Application behavior when receiving catchable signals:</p>
          <table>
            <tr><th>Signal</th><th>Nginx behavior</th><th>Viaduct behavior</th></tr>
            <tr><td>2(INT),15(TERM)</td><td>Quick shutdown</td><td>Close tcp connections, abandom queries and HTTP connections.</td></tr>
            <tr><td>3(QUIT)</td><td>Graceful shutdown</td><td>Do not accept new requests, finish and return existing data for queries in queues.</td></tr>
            <tr><td>1(HUP)</td><td>Configuration reload. Start the new worker processes with a new configuration. Gracefully shutdown the old worker processes.</td><td>Configuration reload. Start the new worker processes with a new configuration. Gracefully shutdown the old worker processes. Do the same for DB connection threads.</td></tr>
            <tr><td>30(USR1)</td><td>Reopen the log files</td><td>Reopen the log files</td></tr>
          </table>
        </div>
      </div>
      <div id="interfaces" class="chapter">
        <h2>Interfaces</h2>
        <div id="http_request" class="chapter">
          <h3>HTTP request</h3>
          <p>The SQL Bridge module should be configurable to be invoked on one or many URIs. By default it must respond to get and post requests at the <code>/sql</code> path.</p>
          <p>HTTP request carries information in the HTTP header and parameter <code>key=value</code> pairs. The application <span class="em">must not</span> expect request information in HTTP headers. Only request parameters must be used. All defaults are configured in the build header files. The parameters below are grouped for the clarity:</p>
          <h4 id="http_request_db">Database server</h4>
          <p><span class="term done">sql_dbtype</span>Database driver name in viaduct. Currently, &laquo;mssql&raquo;  or &laquo;mysql&raquo; . The &laquo;mssql&raquo;  value is default, if the field is missing.</p>
          <p><span class="term done">sql_server</span>Hostname on which the SQL server is running.</p>
          <p><span class="term done">sql_port</span>Optional port number, on which the SQL server is listening. 1433 is the default.</p>
          <p><span class="term done">sql_database</span>Optional name of the primary database for the connection. User's default database is used, if not specified.</p>
          <p><span class="term done">sql_user</span>Username string recognised by the SQL server.</p>
          <p><span class="term done">sql_password</span>Optional password for the sql_user.</p>
          <h4 id="http_request_conn">Connection lifecycle</h4>
          <p><span class="term done">connection_name</span>Optional name to persist this connection under.</p>
          <p><span class="term done">connection_timeout</span>Optional number of seconds from the response to the last query before the connection will be considered idle and marked for destroying. The default is 60. The silently enforced maximum connection lifespan is 28800 (8 hours).</p>
          <p><span class="term done">http_keepalive</span>Optional flag to support broken HTTP clients.  When set to <span>0</span> Viaduct will close an HTTP 1.1 connection after returning the response.  Has no effect on HTTP 1.0 connections.</span></p>
          <p><span class="term done">query_tag</span>Optional tag which will be returned verbatim with the response. Used to help client to identify responses to asynchronous requests.</p>
          <p><span class="term todo">log_level</span>Optional log level setting for the whole application, connection or the specific query.</p>
          <p><span class="term todo">log_level_scope</span>Optional value of either &laquo;<code>server</code>&raquo;, &laquo;<code>connection</code>&raquo;, or &laquo;<code>query</code>&raquo; value which designated the scope of applying the specified scope_level. By default it is assumed to be &laquo;query&raquo;. When the scope is set to &laquo;<code>connection</code>&raquo;, then all connections, matching the &laquo;sql_server&raquo;, &laquo;sql_port&raquo;, &laquo;sql_database&raquo;, and &laquo;sql_user&raquo; request parameters, <em>current or new</em>, log according to the specified level. An absent optional parameter acts as a wildcard. Setting the &laquo;server&raquo; scope resets all the &laquo;connection&raquo;-specific log levels.</p>
          <h4 id="http_request_query">SQL query</h4>
          <p><span class="term done">sql</span>Optional TSQL statement batch conformant with MS SQL Server 2005 TSQL. &quot;Sql&quot; and &quot;param[]&quot; parameters may be omitted when, for example, setting the new application log level.</p>
          <p><span class="term done">param<em>X</em></span>Optional postfix-numbered set of colon-separated pairs &laquo;<code>type</code>&raquo;:&laquo;<code>value</code>&raquo; of positional SQL parameters to be bound into the SQL query. Output parameters are not supported. Parameters should come as an integer-indexed zero-based sequence. <span class="todo">Gaps in parameter indexes should cause notice-level errors</span>. SQL parameter values are expected to be URL-encoded. The accepted &laquo;<code>type</code>&raquo; values are <code>int</code>, <code>smallint</code>, <code>tinyint</code>, <code>numeric</code>, <code>float</code>, <code>real</code>, <code>char</code>, <code>varchar</code>, <code>datetime</code>, <code>smalldatetime</code>.</p>
          <p><span class="term todo">error_style</span>Optionally either &quot;http&quot; or &quot;json&quot;, specifying either to return HTTP 5xx reply, or JSON response with error in the &quot;log&quot; JSON object. The default is &quot;json&quot;.</p>
          <h4 id="http_admin_request">Administrative requests</h4>
          <p><span class="term todo">admin</span>A keyword to get to the set of administrative commands. When specified, only administrative request&#x27;s parameters are taken in consideration. A specific administrative parameter is expected in the same http request.</p>
          <p><span class="term todo">status</span>Request the server status as a part of the administrative http request.</p>
          <p><span class="term todo">cmd</span>Execute a command on the sever. <span class="todo">Specific commands and their format to be decided later in the project.</span></p>
        </div>
        <div id="http_response" class="chapter">
          <h3>HTTP response (JSON)</h3>
          <p>The Viaduct application will return the results as &quot;<code>application/json</code>&quot; ContentType.</p>
          <p>An HTTP response is described as a JSON object below. Regular text is for literals, <span class="ab">italic caps</span> are for the terms defined later in the specification, and <span class="json_term">underlined</span> words are for <a href="http://json.org/">JSON-defined terms</a>. Object members may appear in any order inside the object. Members marked with &laquo;?&raquo; are optional. Array elements or object members, marked with &quot;&middot; &middot; &middot;&quot; after them, occur <span class="em">zero</span> or more times.</p>
          <p class="spec"><span class="term done"><span class="ab">response</span></span>
            {<br />
            <span class="indent">
              request : <span class="ab">request_object</span> ,<br />
              data    : <span class="ab">rowsets_array</span>     , &laquo;?&raquo; <br />
              log     : <span class="ab">log_object</span>        &laquo;?&raquo; <br />
            </span>  
            }
          </p>
          <p class="spec"><span class="term done"><span class="ab">request_object</span></span>
            {<br />
            <span class="indent">
              query_tag       : <span class="json_term">string</span> , &laquo;?&raquo; <br />
              sql_server      : <span class="json_term">string</span> ,<br />
              sql_port        : <span class="json_term">int</span>    , &laquo;?&raquo; <br />
              sql_database    : <span class="json_term">string</span> , &laquo;?&raquo; <br />
              sql_user        : <span class="json_term">string</span> ,<br />
              connection_name : <span class="json_term">string</span> &laquo;?&raquo; <br />
            </span>
            }
          </p>
          <p class="spec"><span class="term done"><span class="ab">rowsets_array</span></span>[
            <span class="ab">rowset</span> , &middot; &middot; &middot;
            ]
          </p>
          <p class="spec"><span class="term done"><span class="ab">rowset</span></span>
            {<br />
            <span class="indent">
              fields : <span class="ab">field_list</span> , &laquo;?&raquo; <br />
              count  : <span class="json_term">int</span>  ,<br />
              rows   : <span class="ab">rows_arrray</span> &laquo;?&raquo; <br />
            </span>
            }
          </p>
          <p class="spec"><span class="term"><span class="ab">field_list</span></span>[
            <span class="ab">field</span>,
            &middot; &middot; &middot;
            ]
          </p>
          <p class="spec"><span class="term"><span class="ab">field</span></span>
            {<br />
              <span class="indent">
                name: <span class="ab">field_name</span> , <br />
                sql_type: <span class="ab">field_type</span> , <br />
                length: <span class="json_term">int</span> , <br />
                precision: <span class="json_term">int</span> , &laquo;?&raquo; <br />
                scale: <span class="json_term">int</span> &laquo;?&raquo; <br />
              </span>
            }
          </p>
          <p class="spec"><span class="term done"><span class="ab">rows_array</span></span>[
            <span class="ab">row</span> , &middot; &middot; &middot;
            ]
          </p>
          <p class="spec"><span class="term done"><span class="ab">row</span></span>{
            <span class="ab">field_name</span> : <span class="json_term">value</span> ,
            &middot; &middot; &middot;
            }
          </p>
          <p class="spec"><span class="term done"><span class="ab">field_name</span></span><span class="json_term">string</span></p>
          <p class="spec"><span class="term"><span class="ab">field_type</span></span><span class="json_term">string</span></p>
          <p class="spec"><span class="term"><span class="ab">log_object</span></span>Content and format of the log object will be defined later in the project.</p>
        </div>
        <div id="log_files" class="chapter">
          <h3>Log and PID files</h3>
          <p>If no directories specified, logs and PID files are created in system-vendor recommended directory as defined in the application source header files. File names, if configurable in Nginx, should include the executable name, listening HTTP port, date and time stamp and, appropriately, have .log or .pid extension. The PID file should only contain a numeric PID of the application process. Content of the log files at appropriate levels will be decided later in the project. If using the system-vendor recommended directories fails, then log and PID files should go into a temporary directory together with <a href="#runtime_files">run time files</a>.</p>
          <p>Log files are written according to the &laquo;log_level&raquo; setting in the <code>syslog</code> format as per &sect;4.1 of <a href="http://tools.ietf.org/rfc/rfc3164.txt">RFC 3164</a>. The messages are assigned to &laquo;user-level messages&raquo; facility (value <code>1</code>). The following are the meanings for the &laquo;log_level&raquo; values, mapped to the <code>syslog</code> &laquo;severity&raquo; levels:</p>
          <p><span class="term">debug</span>The complete http connection, request and database server lifecycle information, including full set of timings on both client and database sides.</p>
          <p><span class="term">informational</span>Live configuration changes. For now, this is only &laquo;<code>log_level</code>&raquo; for &laquo;<code>server</code>&raquo; and &laquo;<code>connection</code>&raquo; scopes.</p>
          <p><span class="term">notice</span>All query errors together with related requests' data, parameters, and client's data: ip address, http headers, excluding passwords.</p>
          <p><span class="term">warning</span>Events, which may indicate misconfiguration or remote error condition, but do not threaten the Viaduct server integrity. Most events, which are likely to impact multiple clients. Connection and request records should include relevant data mentioned above. Passwords should not be logged. Example events:</p>
          <ul class="dense">
            <li>Timeouts on database server queries.</li>
            <li>Malformed requests.</li>
            <li>Errors establishing connections.</li>
            <li>Connections re-established more often than once every three seconds.</li>
          </ul>                                                                      
          <p><span class="term">error</span>Unsolicited database server side disconnects. Provides:</p>
          <ul class="dense">
            <li>The affected connection data with all its parameters, excluding password. Include connection remote IP address, time established, requests per hour, data in and data out.</li>
            <li>Active and pending requests per each connection, with all the requests' parameters and client's data: ip address, http headers, excluding passwords.</li>
          </ul>
          <p><span class="term">critical</span>Log only when Viaduct server can not continue and will shutdown. the following data is reported:</p>
          <ul class="dense">
            <li>List of open connections with all their parameters, excluding passwords. Include connection remote IP addresses, time established, requests per hour, data in and data out.</li>
            <li>Active and pending requests per each connection, with all the requests' parameters and client data: ip address, http headers, excluding passwords.</li>
            <li>Server process stats - PID, UID, GID, memory sizes, configs, whatever else developer deems reasonable.</li>
          </ul>
        </div>
        <div id="static_files" class="chapter">
          <h3>Static files</h3>
          <p>Examles of static files are HTML, JavaScript, CSS, SWF, Image and other files, which are sent to HTTP clients straight from the server's filesystem without modifications.</p>
          <p>If no --root directory specified, static files are searched for in system-vendor recommended directory as defined in the application source header files.</p>
        </div>
        <div id="runtime_files" class="chapter">
          <h3>Run time files</h3>
          <p>The web server needs a place for temporary files, currently residing in the <code>client_body_temp</code>, <code>fastcgi_temp</code>, and <code>proxy_temp</code> subdirectories of the build&#x27;s <code>PREFIX</code> directory. If those do not exist per the build-time configuration, the server will create them in a single temporary directory. The directory should be removed during the graceful process shutdown. No cleanup attempted in the case of abnormal shutdown. Name of the temporary directory should be available via <span class="todo">a management web page</span>.</p>
        </div>
        <div id="command_line" class="chapter">
          <h3>Command line parameters</h3>
          <p>The application must have defaults for everything, so all command line parameters are optional.</p>
          <table>
            <tr><th>Parameter name</th><th>Value</th><th>Default</th><th>Description</th></tr>
            <tr><td>--port</td><td>integer</td><td>80</td><td>A TCP port number for the Viaduct's HTTP server to listen on.</td></tr>
              <tr><td>--root</td><td>directory</td><td>hardcoded per build target in header files</td><td>A directory for the Viaduct's HTTP server to serve the static files from.</td></tr>
            <tr><td>--config</td><td>file name</td><td>hardcoded per build target in header files</td><td>A file name for run-time configuration to load.</td></tr>
            <tr><td>--log-dir</td><td>directory name</td><td>hardcoded per build target in header files</td><td>A directory name where the log files should go.</td></tr>
            <tr><td>--pid-file</td><td>file name</td><td>hardcoded per build target in header files</td><td>A file name for the PID file.</td></tr>
          </table>
        </div>
      </div>
      <div id="environment" class="chapter">
        <h2>Environment</h2>
        <p>The Viaduct application must run on plain installs of Linux distribution CentOS versions between 5.2 and 6.0, both 32 and 64 bit, and Mac OS X versions between 10.5.4 and 10.6, without development packages installed. It should compile on the same platforms with only their vendor-provided development environments installed. The HTTP capabilities on the Viaduct application should be compatible with those of Firefox version 2 and later on Mac OS X 10.5 and Windows XP and Internet Explorer version 7 or later on Windows XP.</p>
      </div>
      <div id="examples" class="chapter">
        <h2>Example</h2>
        <p>The following is a Viaduct query example from client-side JavaScript. The example uses the <code>$.post()</code> function from external <code>jQuery</code> library to implement the AJAX post. It executes three asynchronous data retrievals at the end of the script. Queries&#x27; tags simply pop up on completion with an <code>alert()</code> function.</p>
        <pre>
&lt;script type=&quot;text/javascript&quot; src=&quot;jquery-1.2.6.pack.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;

  // query function - will be included in external library
  function viaductQuery( viaduct, connection, sql, callback, tag) {
    connection[ &quot;sql&quot; ] = sql;
    if ( tag !== undefined ) connection[ &quot;query_tag&quot; ] = tag;
    $.post( viaduct, connection, callback, &quot;json&quot;);
  };

  // connectivity setup
  var viaduct = &quot;http://viaduct/sql&quot;;
  var sql_conn = {
    sql_server : &quot;dbserver&quot;,
    sql_user   : &quot;public&quot;
  };

  // callback function
  function gotResponse( response ) {
    alert( &#x27;The &quot;&#x27; + response.request.query_tag + &#x27;&quot; query has just returned.&#x27; );
  };

  // run the queries
  viaductQuery( viaduct, sql_conn, &quot;exec ExampleProc1&quot;, gotResponse, &quot;First&quot; );
  viaductQuery( viaduct, sql_conn, &quot;exec ExampleProc2&quot;, gotResponse, &quot;Second&quot; );
  viaductQuery( viaduct, sql_conn, &quot;exec ExampleProc3&quot;, gotResponse, &quot;Third&quot; );

&lt;/script&gt;
        </pre>
      </div>
    </div>
    <p class="end_mark">&diams;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&diams;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&diams;</p>
  </body>
</html>
