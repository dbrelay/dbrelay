#!/bin/sh

set -x

if [ "$1" = "--help" ]
then
	echo ""
	echo "--help           this message"
	echo "--prefix=PATH    set the installation prefix"
	echo "--conf-file=PATH give the path to the default configuration file"
	echo ""
	exit
fi

OPTION=`echo $1 | cut -f1 -d=`

if [ "$OPTION" = "--prefix" ]
then
	PREFIX=`echo $1 | cut -f2 -d=`
else
	PREFIX=/usr/local
fi

OPTION=`echo $1 | cut -f1 -d=`

if [ "$OPTION" = "--conf-file" ]
then
	CONFPATH=`echo $2 | cut -f2 -d=`
else
	CONFPATH=conf/internal.conf
fi

BUILD=`pwd`
cd src/freetds-0.82
./configure --prefix=$BUILD/freetds-0.82 --with-tdsver=8.0; make

cd $BUILD
cd src/ngx_http_viaduct
echo "s#FREETDS#$BUILD/src/freetds-0.82#g" > /tmp/sedfile.$$
if [ `uname` = "Darwin" ]
then
echo "s#VIADUCT_EXTRA_LIBS#-liconv#g" >> /tmp/sedfile.$$
elif [ `uname` = "Linux" ]
then
echo "s#VIADUCT_EXTRA_LIBS#-lrt#g" >> /tmp/sedfile.$$
else
echo "s#VIADUCT_EXTRA_LIBS##g" >> /tmp/sedfile.$$
fi
cat config.in | sed -f /tmp/sedfile.$$ > config
rm -f /tmp/sedfile.$$

cd $BUILD
cd src/nginx-0.7.22
HEAD=`grep '^"DEFAULT_CONF_IN"$' -n src/core/ngx_default_conf.h.in | cut -f1 -d:`
WC=`wc -l src/core/ngx_default_conf.h.in | awk '{print $1}'`
TAIL=`expr $WC - $HEAD`
HEAD=`expr $HEAD - 1`
head -$HEAD src/core/ngx_default_conf.h.in > src/core/ngx_default_conf.h
cat $CONFPATH | sed -e 's/^/"/' | sed -e 's/$/"/' >> src/core/ngx_default_conf.h
tail -$TAIL src/core/ngx_default_conf.h.in >> src/core/ngx_default_conf.h

./configure --prefix=$PREFIX --with-pcre=$BUILD/src/pcre-7.7/ --add-module=$BUILD/src/ngx_http_viaduct
make
make install

cd $PREFIX
patch -N -p0 -i $BUILD/patches/nginx.conf.patch
[ -d html ] || mkdir -p html
[ -d html/eg/ ] || mkdir -p html/eg
[ -d html/js ] || mkdir -p html/js
[ -d html/img ] || mkdir -p html/img
[ -d html/doc ] || mkdir -p html/doc
[ -d html/tablesorter ] || mkdir -p html/tablesorter
cp $BUILD/html/* html
cp $BUILD/html/js/* html/js
cp $BUILD/html/eg/* html/eg
cp $BUILD/html/img/* html/img
cp $BUILD/html/tablesorter/* html/tablesorter
cp $BUILD/doc/* html/doc
