<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Viaduct table example</title>
    <script type="text/javascript" src="jquery-1.2.6.pack.js"></script>
    <script type="text/javascript" charset="utf-8">

      $(document).ajaxError(function(){
          if (window.console && window.console.error) {
              console.error(arguments);
          }
      });
      
      function viaductQuery( viaduct, connection, sql, callback, tag) {
        connection[ "sql" ] = sql;
        if ( tag !== undefined ) connection[ "query_tag" ] = tag;
        $.post( viaduct, connection, callback, "json");
      };

      $(document).ready(function() {
        $('#go').click(function(){
          $('#results').empty();
          viaductQuery(
            '/sql',
            {
              'sql_server'   : $('#sql_server')[0].value,
              'sql_database' : $('#sql_database')[0].value,
              'sql_user'     : $('#sql_user')[0].value,
              'sql_password' : $('#sql_password')[0].value
            },
            $('#sql')[0].value,
            processRowSets,
            'Example'
          );
        })
      });
      
      function processRowSets( response ) {
        for ( rs_id in response.data ) {
          rowset = response.data[ rs_id ];
          if ( rowset.count ){
            makeTable( rowset )
          };
          $('<hr>').appendTo( '#results' );
        };
        $('<pre>').html(response.log.sql).appendTo( '#results' );
      };

      var makeTable = function( rowset ) {
        table = $( '<table>' );
        tr = $( '<tr>' ).appendTo( table );
        headers = [];
        for ( field in rowset.fields ) {
          header = rowset.fields[ field ][ 'name' ];
          $( '<th>' ).html( header ).appendTo( tr );
          headers.push( header );
        };
        for ( row_id in rowset.rows ) {
          row = rowset.rows[ row_id ];
          tr = $( '<tr>' ).appendTo( table );
          for ( idx in headers ) {
            $( '<td>' ).html( row[ headers[ idx ] ] ).appendTo( tr );
          };
        };
        table.appendTo( '#results' );
        return table;
      };
      
    </script>
    <style type="text/css" media="screen">
      table { border-collapse: collapse;
              margin-bottom: 0.5em; }
      td { border: 1px solid gray;
           padding: 0.5em; }
      hr { border: 1px dotted navy;
           margin: 2em; }
      label { width: 6em;
              text-align: right;
              float: left;
              padding-right: 1em; }
    </style>
  </head>
  <body>
    <form id=accept-charset="utf-8">
      <label for="sql_server">Server</label><input type="text" name="sql_server" value="" id="sql_server"><br />
      <label for="sql_database">Database</label><input type="text" name="sql_database" value="" id="sql_database"><br />
      <label for="sql_user">User</label><input type="text" name="sql_user" value="" id="sql_user"><br />
      <label for="sql_password">Password</label><input type="password" name="sql_password" value="" id="sql_password"><br />
      <label for="sql">Query</label><textarea name="sql" rows="8" cols="40" id="sql"></textarea>
      <p><input type="button" id="go" value="GO&nbsp;&nbsp;&gt;&nbsp;&gt;&nbsp;&gt;"></p>
    </form>
    <div id="results">
    </div>
  </body>
</html>
