--- auto/sources	2008-11-10 10:22:33.000000000 -0500
+++ auto/sources	2008-12-16 10:49:31.000000000 -0500
@@ -38,6 +38,7 @@
 
 
 CORE_SRCS="src/core/nginx.c \
+           src/core/viaduct.c \
            src/core/ngx_log.c \
            src/core/ngx_palloc.c \
            src/core/ngx_array.c \
--- src/core/viaduct.c  2008-12-23 07:31:40.000000000 -0500
+++ src/core/viaduct.c	2008-12-16 10:04:33.000000000 -0500
@@ -0,0 +1,51 @@
+
+/*
+ * Copyright (C) Igor Sysoev
+ */
+
+
+#include <ngx_config.h>
+#include <ngx_core.h>
+#include <nginx.h>
+#include <getopt.h>
+#include "../../../../ngx_http_viaduct/src/viaduct.h"
+
+int ngx_cdecl ngx_main(int argc, char *const *argv);
+void ngx_http_viaduct_exit_master(ngx_cycle_t *cycle);
+
+int ngx_cdecl
+main(int argc, char *const *argv)
+{
+     viaduct_connection_t *buf;
+ 
+     static struct option long_options[] =
+     {
+        {"clean",     no_argument,       0, 'c'},
+        {0, 0, 0, 0}
+     };
+     /* getopt_long stores the option index here. */
+     int option_index = 0;
+     int c;
+     
+     do {
+        c = getopt_long(argc, argv, "", long_options, &option_index);
+     
+        switch (c)
+        {
+           case 'c': 
+              printf("Cleaning up old instance(s).\n");
+              ngx_http_viaduct_exit_master(NULL);
+              exit(0); 
+              break;
+        }
+     } while(c!=-1);
+
+    // initialize shared memory and semaphore
+    if ((buf=viaduct_get_shmem())==NULL) {
+       viaduct_create_shmem();
+    } else {
+       viaduct_release_shmem(buf);
+    }
+
+    return ngx_main(argc, argv);
+}
--- src/core/nginx.c	2008-11-11 11:17:45.000000000 -0500
+++ src/core/nginx.c	2008-12-16 06:55:02.000000000 -0500
@@ -189,7 +189,7 @@
 
 
 int ngx_cdecl
-main(int argc, char *const *argv)
+ngx_main(int argc, char *const *argv)
 {
     char             *p;
     ssize_t           n;
